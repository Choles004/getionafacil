<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestiona Fácil - Gestión de Caja</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Estilos Personalizados Embebidos -->
    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-bg-light: #f8f9fa; --sidebar-text-light: #212529;
            --sidebar-link-hover-bg-light: #e9ecef; --sidebar-link-active-bg-light: #0d6efd; --sidebar-link-active-color-light: #ffffff;
            --sidebar-bg-dark: #212529; --sidebar-text-dark: #adb5bd;
            --sidebar-link-hover-bg-dark: #343a40; --sidebar-link-active-bg-dark: #0d6efd; --sidebar-link-active-color-dark: #ffffff;
        }
        body { display: flex; min-height: 100vh; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); flex-shrink: 0; background-color: var(--sidebar-bg-light); color: var(--sidebar-text-light); transition: background-color 0.3s ease, color 0.3s ease; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; border-right: 1px solid var(--bs-border-color); }
        .sidebar .nav-link { color: var(--sidebar-text-light); }
        .sidebar .nav-link:hover { background-color: var(--sidebar-link-hover-bg-light); }
        .sidebar .nav-link.active { background-color: var(--sidebar-link-active-bg-light); color: var(--sidebar-link-active-color-light); font-weight: 500; }
        .sidebar .nav-link i { margin-right: 0.75rem; width: 20px; text-align: center; }
        .main-content { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }
        [data-bs-theme="dark"] .sidebar { background-color: var(--sidebar-bg-dark); color: var(--sidebar-text-dark); border-right: 1px solid var(--bs-border-color); }
        [data-bs-theme="dark"] .sidebar .nav-link { color: var(--sidebar-text-dark); }
        [data-bs-theme="dark"] .sidebar .nav-link:hover { background-color: var(--sidebar-link-hover-bg-dark); color: #fff; }
        [data-bs-theme="dark"] .sidebar .nav-link.active { background-color: var(--sidebar-link-active-bg-dark); color: var(--sidebar-link-active-color-dark); }
        [data-bs-theme="dark"] .sidebar .btn-theme-toggle { border-color: var(--sidebar-text-dark); color: var(--sidebar-text-dark); }
        [data-bs-theme="dark"] .sidebar .btn-theme-toggle:hover { background-color: var(--sidebar-link-hover-bg-dark); color: #fff; }
        .sidebar-footer { margin-top: auto; padding: 1rem; border-top: 1px solid var(--bs-border-color); }
        .btn-theme-toggle { width: 100%; text-align: left; }
        .btn-theme-toggle i { margin-right: 0.5rem; width: 15px; }
        #logout-button { width: 100%; text-align: left; margin-top: 0.5rem; }
        #logout-button i { margin-right: 0.5rem; width: 15px;}

        /* Estilos Caja */
        #open-cash-register-section, #close-cash-register-section { display: none; } /* Ocultos inicialmente */
        .summary-item { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px dashed var(--bs-border-color-translucent); }
        .summary-item:last-child { border-bottom: none; }
        .summary-item span:first-child { font-weight: 500; }
        .difference-positive { color: var(--bs-success); }
        .difference-negative { color: var(--bs-danger); }
        #cash-history-table th, #cash-history-table td { padding: 0.5rem; font-size: 0.9rem; vertical-align: middle;}
        .badge.bg-success { font-size: 1rem; }
        .badge.bg-danger { font-size: 1rem; }

        @media (max-width: 768px) {
            :root { --sidebar-width: 70px; }
            .sidebar .nav-link span, .sidebar .app-brand-text, .sidebar .btn-theme-toggle span, .sidebar #logout-button span { display: none; }
            .sidebar .nav-link i, .sidebar #logout-button i { margin-right: 0; }
            .sidebar .app-logo { padding: 0.5rem; font-size: 1.5rem; }
            .sidebar .sidebar-footer { padding: 0.5rem; }
            .btn-theme-toggle, #logout-button { text-align: center; }
            .btn-theme-toggle i, #logout-button i { margin-right: 0; }
             #cash-history-table th, #cash-history-table td { font-size: 0.85rem; }
        }
         @media (max-width: 576px) {
              .main-content { padding: 1rem; }
         }
    </style>
</head>
<body>
    <!-- Barra Lateral Fija -->
    <aside class="sidebar p-3 d-flex flex-column vh-100 sticky-top">
        <div class="app-logo text-center mb-4">
             <a href="dashboard.html" class="text-decoration-none d-flex align-items-center justify-content-center">
                 <i class="fas fa-store fa-lg me-2"></i>
                 <span id="sidebar-business-name" class="app-brand-text fs-5 fw-bold">Gestiona Fácil</span>
             </a>
        </div>
        <nav class="nav flex-column nav-pills flex-grow-1">
             <a class="nav-link" href="dashboard.html"><i class="fas fa-tachometer-alt"></i><span>Panel Principal</span></a>
             <a class="nav-link" href="nueva_venta.html"><i class="fas fa-cash-register"></i><span>Nueva Venta</span></a>
             <a class="nav-link" href="productos.html"><i class="fas fa-boxes"></i><span>Productos</span></a>
             <a class="nav-link" href="clientes.html"><i class="fas fa-users"></i><span>Clientes</span></a>
             <a class="nav-link" href="proveedores.html"><i class="fas fa-truck-loading"></i><span>Proveedores</span></a>
             <a class="nav-link" href="gastos.html"><i class="fas fa-receipt"></i><span>Gastos</span></a>
             <a class="nav-link active" href="caja.html"><i class="fas fa-calculator"></i><span>Caja</span></a>
             <a class="nav-link" href="inventario.html"><i class="fas fa-clipboard-list"></i><span>Inventario</span></a>
             <a class="nav-link" href="reportes.html"><i class="fas fa-chart-line"></i><span>Reportes</span></a>
             <a class="nav-link" href="configuracion.html"><i class="fas fa-cog"></i><span>Configuración</span></a>
             <a class="nav-link d-none" id="restaurant-link" href="restaurante.html"><i class="fas fa-utensils"></i><span>Restaurante</span></a>
             <a class="nav-link" href="ayuda.html"><i class="fas fa-question-circle"></i><span>Ayuda</span></a>
        </nav>
        <div class="sidebar-footer mt-auto">
            <button id="theme-toggle" class="btn btn-outline-secondary btn-theme-toggle" title="Cambiar Tema">
                 <i class="fas fa-sun"></i> <span></span>
            </button>
            <button id="logout-button" class="btn btn-outline-danger btn-sm" title="Salir">
                 <i class="fas fa-sign-out-alt"></i> <span>Salir</span>
            </button>
        </div>
    </aside>

    <!-- Contenido Principal -->
    <main class="main-content">
        <div class="container-fluid">
            <h1 class="mb-4">Gestión de Caja</h1>

            <div class="row g-4">
                <!-- Columna Izquierda: Estado y Acciones -->
                <div class="col-lg-5">
                    <!-- Estado Actual -->
                    <div class="card mb-4 shadow-sm">
                         <div class="card-header">
                             <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> Estado Actual de la Caja</h5>
                         </div>
                        <div class="card-body text-center">
                            <p class="fs-4">La caja está actualmente:</p>
                            <p id="cash-register-status-badge" class="badge fs-2 mb-3">--</p>
                            <p id="cash-register-details" class="text-muted mb-0">--</p>
                        </div>
                    </div>

                    <!-- Abrir Caja (si está cerrada) -->
                    <div id="open-cash-register-section" class="card mb-4 shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-door-open me-2"></i> Abrir Caja</h5>
                        </div>
                        <div class="card-body">
                            <form id="open-form" novalidate>
                                <div class="mb-3">
                                    <label for="opening-balance" class="form-label">Saldo Inicial (Efectivo) <span class="text-danger">*</span></label>
                                     <div class="input-group">
                                        <span class="input-group-text" id="currency-symbol-open">$</span>
                                        <input type="number" step="any" min="0" class="form-control" id="opening-balance" required value="0">
                                        <div class="invalid-feedback">El saldo inicial es obligatorio (puede ser 0).</div>
                                    </div>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success"><i class="fas fa-play me-1"></i> Confirmar Apertura</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Cerrar Caja (si está abierta) -->
                     <div id="close-cash-register-section" class="card mb-4 shadow-sm">
                        <div class="card-header">
                             <h5 class="mb-0"><i class="fas fa-door-closed me-2"></i> Cerrar Caja</h5>
                        </div>
                         <div class="card-body">
                             <form id="close-form" novalidate>
                                 <h6 class="mb-3">Resumen Calculado (Desde Apertura)</h6>
                                 <div class="list-group list-group-flush mb-3 border rounded">
                                    <div class="list-group-item summary-item"><span>Saldo Inicial:</span> <span id="summary-opening-balance">--</span></div>
                                    <div class="list-group-item summary-item"><span>(+) Ventas Efectivo:</span> <span id="summary-cash-sales" class="text-success">--</span></div>
                                    <div class="list-group-item summary-item"><span>(+) Ingresos Efectivo (Otros):</span> <span id="summary-cash-in" class="text-success">--</span></div> <!-- Placeholder futuro -->
                                    <div class="list-group-item summary-item"><span>(-) Gastos Efectivo:</span> <span id="summary-cash-expenses" class="text-danger">--</span></div>
                                     <div class="list-group-item summary-item"><span>(-) Retiros Efectivo (Otros):</span> <span id="summary-cash-out" class="text-danger">--</span></div> <!-- Placeholder futuro -->
                                    <div class="list-group-item summary-item bg-light"><strong>(=) Saldo Efectivo Esperado:</strong> <strong id="summary-expected-balance">--</strong></div>
                                 </div>

                                 <h6 class="mb-3">Conteo Real de Efectivo</h6>
                                 <div class="mb-3">
                                     <label for="actual-cash-count" class="form-label">Monto Total Contado <span class="text-danger">*</span></label>
                                     <div class="input-group">
                                        <span class="input-group-text" id="currency-symbol-close">$</span>
                                        <input type="number" step="any" min="0" class="form-control" id="actual-cash-count" required>
                                        <div class="invalid-feedback">Debes ingresar el monto contado.</div>
                                    </div>
                                 </div>
                                 <div class="mb-3">
                                    <label for="closing-notes" class="form-label">Notas del Cierre (Opcional)</label>
                                     <textarea id="closing-notes" class="form-control" rows="2"></textarea>
                                 </div>

                                 <div id="closing-summary-difference" class="alert mb-3" role="alert">
                                     Diferencia: <strong id="difference-amount">--</strong>
                                 </div>

                                 <div class="d-grid">
                                    <button type="submit" class="btn btn-danger"><i class="fas fa-lock me-1"></i> Confirmar Cierre de Caja</button>
                                 </div>
                             </form>
                         </div>
                     </div>

                </div>

                <!-- Columna Derecha: Historial de Cierres -->
                <div class="col-lg-7">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-history me-2"></i> Historial de Cierres de Caja</h5>
                        </div>
                        <div class="card-body p-0">
                             <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0" id="cash-history-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Fecha Cierre</th>
                                            <th>Fecha Apertura</th>
                                            <th>Saldo Inicial</th>
                                            <th>Saldo Esperado</th>
                                            <th>Saldo Real</th>
                                            <th>Diferencia</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Filas aquí -->
                                         <tr>
                                             <td colspan="7" class="text-center p-4">
                                                 <div id="loading-history-message"><div class="spinner-border spinner-border-sm"></div> Cargando...</div>
                                                 <div id="empty-history-message" class="d-none text-muted">No hay cierres de caja registrados.</div>
                                             </td>
                                         </tr>
                                    </tbody>
                                </table>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- /.container-fluid -->
    </main>


    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- JavaScript Personalizado Embebido -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos del DOM ---
            const themeToggleButton = document.getElementById('theme-toggle'); const htmlElement = document.documentElement; const themeIcon = themeToggleButton.querySelector('i'); const themeText = themeToggleButton.querySelector('span'); const logoutButton = document.getElementById('logout-button'); const sidebarBusinessName = document.getElementById('sidebar-business-name'); const restaurantLink = document.getElementById('restaurant-link');
            const statusBadge = document.getElementById('cash-register-status-badge');
            const statusDetails = document.getElementById('cash-register-details');
            const openSection = document.getElementById('open-cash-register-section');
            const closeSection = document.getElementById('close-cash-register-section');
            const openForm = document.getElementById('open-form');
            const openingBalanceInput = document.getElementById('opening-balance');
            const closeForm = document.getElementById('close-form');
            const summaryOpeningBalance = document.getElementById('summary-opening-balance');
            const summaryCashSales = document.getElementById('summary-cash-sales');
            const summaryCashIn = document.getElementById('summary-cash-in'); // Placeholder
            const summaryCashExpenses = document.getElementById('summary-cash-expenses');
            const summaryCashOut = document.getElementById('summary-cash-out'); // Placeholder
            const summaryExpectedBalance = document.getElementById('summary-expected-balance');
            const actualCashCountInput = document.getElementById('actual-cash-count');
            const closingNotesInput = document.getElementById('closing-notes');
            const closingSummaryDifference = document.getElementById('closing-summary-difference');
            const differenceAmount = document.getElementById('difference-amount');
            const cashHistoryTableBody = document.querySelector('#cash-history-table tbody');
            const loadingHistoryMessage = document.getElementById('loading-history-message');
            const emptyHistoryMessage = document.getElementById('empty-history-message');
            const currencySymbolOpen = document.getElementById('currency-symbol-open');
            const currencySymbolClose = document.getElementById('currency-symbol-close');

            let currencyConfig = {};
            let cashRegisterStatus = {};
            let cashHistory = [];
            let salesData = [];
            let expensesData = [];
            let expectedBalance = 0; // Variable para almacenar el saldo esperado calculado

            // --- Lógica Tema, Sidebar, Auxiliares (Igual que antes) ---
            const applyTheme = (theme) => { /* ... */ htmlElement.setAttribute('data-bs-theme', theme); if (theme === 'dark') { themeIcon.className = 'fas fa-sun'; themeText.textContent = ' Tema Claro'; } else { themeIcon.className = 'fas fa-moon'; themeText.textContent = ' Tema Oscuro'; } try { localStorage.setItem('preferredTheme', theme); } catch (e) {} };
            const loadTheme = () => { /* ... */ let pT = null; try { pT = localStorage.getItem('preferredTheme'); } catch (e) {} if (pT) { applyTheme(pT); } else { const pD = window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(pD ? 'dark' : 'light'); } };
            themeToggleButton.addEventListener('click', () => { const cT = htmlElement.getAttribute('data-bs-theme'); applyTheme(cT === 'dark' ? 'light' : 'dark'); }); loadTheme();
            logoutButton.addEventListener('click', () => { if (confirm('¿Seguro?')) window.location.href = 'login.html'; });
            function loadData(key, defaultValue = null) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : defaultValue; } catch (e) { console.error(`LS Load (${key}):`, e); return defaultValue; } }
            function saveData(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); return true; } catch (e) { console.error(`LS Save (${key}):`, e); alert(`Error al guardar ${key}.`); return false; } }
            function generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }
            function getLocaleForCurrency(code) { const map = { 'USD': 'en-US', /*...*/ 'COP': 'es-CO', 'MXN': 'es-MX', /*...*/ }; return map[code]; }
            function formatCurrency(amount, config) { /* ... (igual que antes) ... */
                 if (amount === null || amount === undefined || isNaN(Number(amount))) { amount = 0; }
                 if (!config || !config.code || config.decimals === undefined) { return Number(amount).toLocaleString('es-ES'); }
                 try { const f = new Intl.NumberFormat(getLocaleForCurrency(config.code) || 'es-ES', { style: 'decimal', minimumFractionDigits: config.decimals, maximumFractionDigits: config.decimals }); const fm = f.format(amount); const s = config.symbol || config.code; if (['USD','EUR','GBP','MXN','ARS','COP','CLP','PEN'].includes(config.code)) return `${s}${fm}`; else return `${fm} ${s}`; }
                 catch (e) { return `${config.symbol || ''}${Number(amount).toFixed(config.decimals || 2)}`; }
            }
            function formatDateTimeForDisplay(isoString, includeTime = true) {
                 if (!isoString) return '--';
                 try { const options = includeTime ? { dateStyle: 'short', timeStyle: 'short' } : { dateStyle: 'short' }; return new Date(isoString).toLocaleString('es-ES', options); }
                 catch (e) { return 'Inválido'; }
             }

             // --- Autenticación y Configuración Inicial ---
            const config = loadData('gestionaFacilConfig');
            if (!config || !config.masterPassword) { window.location.href = 'login.html'; return; }
            currencyConfig = config.currency || { code: 'USD', symbol: '$', decimals: 2 };
            currencySymbolOpen.textContent = currencyConfig.symbol || '$';
            currencySymbolClose.textContent = currencyConfig.symbol || '$';
            if (config.businessName) sidebarBusinessName.textContent = config.businessName;
            if (config.businessType === 'restaurant') restaurantLink.classList.remove('d-none');

            // --- Lógica Principal ---
            function updateUI() {
                // Cargar datos frescos
                cashRegisterStatus = loadData('cashRegisterStatus', { isOpen: false, openingTime: null, openingBalance: 0, lastCloseTime: null });
                cashHistory = loadData('cashHistory', []);
                salesData = loadData('ventas', []);
                expensesData = loadData('gastos', []);

                // 1. Actualizar Estado
                if (cashRegisterStatus.isOpen) {
                    statusBadge.textContent = 'ABIERTA';
                    statusBadge.className = 'badge bg-success fs-2 mb-3';
                    statusDetails.textContent = `Abierta desde ${formatDateTimeForDisplay(cashRegisterStatus.openingTime)} con ${formatCurrency(cashRegisterStatus.openingBalance, currencyConfig)}`;
                    openSection.style.display = 'none';
                    closeSection.style.display = 'block';
                    calculateClosingSummary(); // Calcular resumen para mostrar en form de cierre
                } else {
                    statusBadge.textContent = 'CERRADA';
                    statusBadge.className = 'badge bg-danger fs-2 mb-3';
                    statusDetails.textContent = cashRegisterStatus.lastCloseTime
                        ? `Último cierre: ${formatDateTimeForDisplay(cashRegisterStatus.lastCloseTime)}`
                        : 'Nunca se ha abierto la caja.';
                    openSection.style.display = 'block';
                    closeSection.style.display = 'none';
                }

                // 2. Renderizar Historial
                renderCashHistory();
            }

            function handleOpenSubmit(event) {
                event.preventDefault();
                if (!openForm.checkValidity()) {
                     openForm.classList.add('was-validated');
                     return;
                }
                const openingBalance = parseFloat(openingBalanceInput.value);
                 if (isNaN(openingBalance) || openingBalance < 0) {
                     openingBalanceInput.classList.add('is-invalid');
                     openForm.classList.add('was-validated');
                     return;
                 } else {
                     openingBalanceInput.classList.remove('is-invalid');
                 }


                cashRegisterStatus.isOpen = true;
                cashRegisterStatus.openingTime = new Date().toISOString();
                cashRegisterStatus.openingBalance = openingBalance;

                if (saveData('cashRegisterStatus', cashRegisterStatus)) {
                    console.log('Caja abierta:', cashRegisterStatus);
                    updateUI();
                    openForm.reset();
                     openForm.classList.remove('was-validated');
                } else {
                     alert("Error al guardar el estado de la caja.");
                     // Revertir estado si falla el guardado? Podría ser complejo.
                }
            }

            function calculateClosingSummary() {
                const openingTime = cashRegisterStatus.openingTime ? new Date(cashRegisterStatus.openingTime) : null;
                let totalCashSales = 0;
                let totalCashExpenses = 0;
                // Futuro: totalCashIn, totalCashOut (ej. ingresos/retiros manuales de efectivo)

                if (openingTime) {
                    // Filtrar ventas y gastos desde la apertura de caja
                    const relevantSales = salesData.filter(sale => {
                        const saleDate = new Date(sale.date);
                        // Incluir pagos en efectivo Y pagos de deuda en efectivo
                        return saleDate >= openingTime && (sale.paymentMethod === 'Efectivo' || sale.paymentMethod === 'Pago Deuda Efectivo');
                    });
                    totalCashSales = relevantSales.reduce((sum, sale) => sum + sale.total, 0);

                    const relevantExpenses = expensesData.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate >= openingTime && expense.paymentMethod === 'Efectivo';
                    });
                    totalCashExpenses = relevantExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                }

                 expectedBalance = (cashRegisterStatus.openingBalance || 0) + totalCashSales - totalCashExpenses; // Añadir otros ingresos/retiros si se implementan

                // Actualizar UI del resumen
                 summaryOpeningBalance.textContent = formatCurrency(cashRegisterStatus.openingBalance || 0, currencyConfig);
                 summaryCashSales.textContent = formatCurrency(totalCashSales, currencyConfig);
                 summaryCashExpenses.textContent = formatCurrency(totalCashExpenses, currencyConfig);
                 summaryExpectedBalance.textContent = formatCurrency(expectedBalance, currencyConfig);

                 // Limpiar campo de conteo real y diferencia
                 actualCashCountInput.value = '';
                 differenceAmount.textContent = '--';
                 closingSummaryDifference.className = 'alert mb-3'; // Resetear clase de alerta
                 closeForm.classList.remove('was-validated'); // Resetear validación

            }

            function updateDifference() {
                const actualCount = parseFloat(actualCashCountInput.value);
                if (isNaN(actualCount) || !isFinite(expectedBalance)) {
                     differenceAmount.textContent = '--';
                     closingSummaryDifference.className = 'alert mb-3';
                     return;
                 }

                const difference = actualCount - expectedBalance;
                differenceAmount.textContent = formatCurrency(difference, currencyConfig);

                if (Math.abs(difference) < 0.01) { // Considerar pequeña tolerancia por decimales
                     closingSummaryDifference.className = 'alert alert-success mb-3';
                } else if (difference > 0) {
                    closingSummaryDifference.className = 'alert alert-warning mb-3'; // Sobrante
                     differenceAmount.textContent += " (Sobrante)";
                } else {
                     closingSummaryDifference.className = 'alert alert-danger mb-3'; // Faltante
                     differenceAmount.textContent += " (Faltante)";
                }
            }

             function handleCloseSubmit(event) {
                event.preventDefault();
                if (!closeForm.checkValidity()) {
                     closeForm.classList.add('was-validated');
                     return;
                }
                const actualCashCount = parseFloat(actualCashCountInput.value);
                 if (isNaN(actualCashCount) || actualCashCount < 0) {
                     actualCashCountInput.classList.add('is-invalid');
                     closeForm.classList.add('was-validated');
                     return;
                 } else {
                     actualCashCountInput.classList.remove('is-invalid');
                 }

                 const closingTime = new Date().toISOString();
                 const difference = actualCashCount - expectedBalance;

                 const historyEntry = {
                     id: generateId(),
                     openingTime: cashRegisterStatus.openingTime,
                     closingTime: closingTime,
                     openingBalance: cashRegisterStatus.openingBalance,
                     expectedBalance: expectedBalance, // Guardar el calculado
                     actualBalance: actualCashCount, // Guardar el contado
                     difference: difference,
                     notes: closingNotesInput.value.trim() || null,
                     // Podríamos guardar resumen de ventas/gastos aquí también si es necesario
                 };

                 // Actualizar estado
                 cashRegisterStatus.isOpen = false;
                 cashRegisterStatus.lastCloseTime = closingTime;
                 // Mantener openingTime y openingBalance hasta la próxima apertura

                 // Guardar historial y estado
                 cashHistory.push(historyEntry);

                  if (saveData('cashHistory', cashHistory) && saveData('cashRegisterStatus', cashRegisterStatus)) {
                     console.log('Caja cerrada. Historial:', historyEntry);
                     updateUI(); // Actualiza UI a estado cerrado y renderiza historial
                     closeForm.reset();
                      closeForm.classList.remove('was-validated');
                 } else {
                      // Revertir si falla
                      cashHistory = loadData('cashHistory', []);
                      cashRegisterStatus = loadData('cashRegisterStatus', {}); // Recargar estado
                      alert("Error al guardar el cierre de caja.");
                 }
             }

            // --- Lógica Historial ---
            function renderCashHistory() {
                loadingHistoryMessage.style.display = 'inline-block';
                emptyHistoryMessage.classList.add('d-none');
                cashHistoryTableBody.innerHTML = '';

                // Ordenar por fecha de cierre descendente
                const sortedHistory = [...cashHistory].sort((a, b) => new Date(b.closingTime) - new Date(a.closingTime));

                 loadingHistoryMessage.style.display = 'none';

                 if (sortedHistory.length === 0) {
                     emptyHistoryMessage.classList.remove('d-none');
                     cashHistoryTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted p-3">No hay cierres previos.</td></tr>`;
                     return;
                 }

                 sortedHistory.forEach(entry => {
                     const diff = entry.difference || 0;
                     let diffClass = '';
                     if (Math.abs(diff) < 0.01) diffClass = 'text-success';
                     else if (diff > 0) diffClass = 'text-warning'; // Sobrante
                     else diffClass = 'text-danger'; // Faltante

                     const tr = document.createElement('tr');
                     tr.innerHTML = `
                        <td>${formatDateTimeForDisplay(entry.closingTime)}</td>
                        <td>${formatDateTimeForDisplay(entry.openingTime)}</td>
                        <td class="text-end">${formatCurrency(entry.openingBalance, currencyConfig)}</td>
                        <td class="text-end">${formatCurrency(entry.expectedBalance, currencyConfig)}</td>
                        <td class="text-end">${formatCurrency(entry.actualBalance, currencyConfig)}</td>
                        <td class="text-end ${diffClass}">${formatCurrency(diff, currencyConfig)}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-info view-details-btn" data-id="${entry.id}" title="Ver Detalles (Próximamente)">
                                <i class="fas fa-eye"></i>
                            </button>
                             <button class="btn btn-sm btn-outline-secondary print-summary-btn" data-id="${entry.id}" title="Descargar Resumen TXT">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                    cashHistoryTableBody.appendChild(tr);
                 });
            }

            // --- Generar Resumen TXT ---
            function generateClosureSummaryTxt(historyEntryId) {
                 const entry = cashHistory.find(h => h.id === historyEntryId);
                 if (!entry) { alert("No se encontró el registro del cierre."); return; }

                 // Recalcular resumen para este periodo específico (similar a calculateClosingSummary pero con fechas del entry)
                 const openingTime = new Date(entry.openingTime);
                 const closingTime = new Date(entry.closingTime);
                 let totalCashSales = 0, salesCount = 0;
                 let totalCashExpenses = 0, expensesCount = 0;
                 let otherCashIn = 0, otherCashOut = 0; // Futuro

                 const relevantSales = salesData.filter(sale => {
                     const saleDate = new Date(sale.date);
                     return saleDate >= openingTime && saleDate <= closingTime && (sale.paymentMethod === 'Efectivo' || sale.paymentMethod === 'Pago Deuda Efectivo');
                 });
                 totalCashSales = relevantSales.reduce((sum, sale) => sum + sale.total, 0);
                 salesCount = relevantSales.length;

                 const relevantExpenses = expensesData.filter(expense => {
                     const expenseDate = new Date(expense.date);
                     return expenseDate >= openingTime && expenseDate <= closingTime && expense.paymentMethod === 'Efectivo';
                 });
                 totalCashExpenses = relevantExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                 expensesCount = relevantExpenses.length;

                 const expected = entry.openingBalance + totalCashSales + otherCashIn - totalCashExpenses - otherCashOut;
                 const actual = entry.actualBalance;
                 const difference = entry.difference;

                 // Crear contenido del TXT
                 let txtContent = `RESUMEN DE CIERRE DE CAJA\n`;
                 txtContent += `=============================\n`;
                 txtContent += `Negocio: ${config.businessName || 'N/A'}\n`;
                 txtContent += `Periodo:\n`;
                 txtContent += `  Apertura: ${formatDateTimeForDisplay(entry.openingTime)}\n`;
                 txtContent += `  Cierre:   ${formatDateTimeForDisplay(entry.closingTime)}\n`;
                 txtContent += `-----------------------------\n`;
                 txtContent += `RESUMEN DE EFECTIVO:\n`;
                 txtContent += `  Saldo Inicial:        ${formatCurrency(entry.openingBalance, currencyConfig)}\n`;
                 txtContent += `  (+) Ventas Efectivo:    ${formatCurrency(totalCashSales, currencyConfig)} (${salesCount} tx)\n`;
                 // txtContent += `  (+) Otros Ingresos Efec.: ${formatCurrency(otherCashIn, currencyConfig)}\n`;
                 txtContent += `  (-) Gastos Efectivo:    ${formatCurrency(totalCashExpenses, currencyConfig)} (${expensesCount} tx)\n`;
                 // txtContent += `  (-) Otros Retiros Efec.: ${formatCurrency(otherCashOut, currencyConfig)}\n`;
                 txtContent += `-----------------------------\n`;
                 txtContent += `  (=) Saldo Esperado:    ${formatCurrency(expected, currencyConfig)}\n`;
                 txtContent += `  Saldo Real Contado:   ${formatCurrency(actual, currencyConfig)}\n`;
                 txtContent += `-----------------------------\n`;
                 txtContent += `  DIFERENCIA:           ${formatCurrency(difference, currencyConfig)} ${difference === 0 ? '' : (difference > 0 ? '(SOBRANTE)' : '(FALTANTE)')}\n`;
                 txtContent += `=============================\n`;
                 if (entry.notes) {
                     txtContent += `Notas del Cierre:\n${entry.notes}\n`;
                     txtContent += `=============================\n`;
                 }
                 txtContent += `Generado: ${formatDateTimeForDisplay(new Date().toISOString())}\n`;

                 // Descargar archivo TXT
                 const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
                 const link = document.createElement("a");
                 const url = URL.createObjectURL(blob);
                 link.setAttribute("href", url);
                 const filename = `cierre_caja_${formatDateTimeForDisplay(entry.closingTime, false).replace(/\//g, '-')}.txt`;
                 link.setAttribute("download", filename);
                 link.style.visibility = 'hidden';
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 URL.revokeObjectURL(url);
             }


            // --- Carga Inicial y Listeners ---
            function initialize() {
                updateUI(); // Carga inicial y muestra estado/historial

                // Listeners
                openForm.addEventListener('submit', handleOpenSubmit);
                closeForm.addEventListener('submit', handleCloseSubmit);
                actualCashCountInput.addEventListener('input', updateDifference); // Actualizar diferencia al escribir

                // Listener delegado para historial
                cashHistoryTableBody.addEventListener('click', (event) => {
                     const button = event.target.closest('button');
                     if (!button) return;
                     const historyId = button.dataset.id;
                     if (!historyId) return;

                     if (button.classList.contains('print-summary-btn')) {
                         generateClosureSummaryTxt(historyId);
                     } else if (button.classList.contains('view-details-btn')) {
                          alert("Vista detallada de ventas/gastos del cierre - ¡Próximamente!");
                          // Aquí iría la lógica para mostrar un modal o sección con detalles
                     }
                });

                 console.log('Página de Caja Inicializada.');
            }

            // --- Iniciar ---
            initialize();
        });
    </script>

</body>
</html>