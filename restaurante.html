<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestiona Fácil - Vista Restaurante</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Estilos Personalizados Embebidos (Refinados v2) -->
    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-bg-light: #f8f9fa; --sidebar-text-light: #212529;
            --sidebar-link-hover-bg-light: #e9ecef; --sidebar-link-active-bg-light: #0d6efd; --sidebar-link-active-color-light: #ffffff;
            --sidebar-bg-dark: #212529; --sidebar-text-dark: #adb5bd;
            --sidebar-link-hover-bg-dark: #343a40; --sidebar-link-active-bg-dark: #0d6efd; --sidebar-link-active-color-dark: #ffffff;
            --table-free-bg: var(--bs-success-bg-subtle); --table-free-border: var(--bs-success-border-subtle);
            --table-occupied-bg: var(--bs-warning-bg-subtle); --table-occupied-border: var(--bs-warning-border-subtle);
            --table-paying-bg: var(--bs-info-bg-subtle); --table-paying-border: var(--bs-info-border-subtle);
            --table-selected-border: var(--bs-primary);
        }

        /* Asegurar altura completa y control de overflow */
        html, body { height: 100%; overflow: hidden; }
        body { display: flex; min-height: 100vh; }

        .sidebar { /* ... (Sin cambios) ... */ width: var(--sidebar-width); flex-shrink: 0; background-color: var(--sidebar-bg-light); color: var(--sidebar-text-light); transition: background-color 0.3s ease, color 0.3s ease; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; border-right: 1px solid var(--bs-border-color); }
        .sidebar .nav-link { color: var(--sidebar-text-light); } .sidebar .nav-link:hover { background-color: var(--sidebar-link-hover-bg-light); } .sidebar .nav-link.active { background-color: var(--sidebar-link-active-bg-light); color: var(--sidebar-link-active-color-light); font-weight: 500; } .sidebar .nav-link i { margin-right: 0.75rem; width: 20px; text-align: center; }
        .main-content { flex-grow: 1; padding: 1rem; overflow-y: hidden; /* Controlar scroll interno */ display: flex; flex-direction: column; height: 100vh; }
        [data-bs-theme="dark"] .sidebar { /* ... */ background-color: var(--sidebar-bg-dark); color: var(--sidebar-text-dark); border-right: 1px solid var(--bs-border-color); } [data-bs-theme="dark"] .sidebar .nav-link { color: var(--sidebar-text-dark); } [data-bs-theme="dark"] .sidebar .nav-link:hover { background-color: var(--sidebar-link-hover-bg-dark); color: #fff; } [data-bs-theme="dark"] .sidebar .nav-link.active { background-color: var(--sidebar-link-active-bg-dark); color: var(--sidebar-link-active-color-dark); } [data-bs-theme="dark"] .sidebar .btn-theme-toggle { border-color: var(--sidebar-text-dark); color: var(--sidebar-text-dark); } [data-bs-theme="dark"] .sidebar .btn-theme-toggle:hover { background-color: var(--sidebar-link-hover-bg-dark); color: #fff; }
        .sidebar-footer { margin-top: auto; padding: 1rem; border-top: 1px solid var(--bs-border-color); } .btn-theme-toggle { width: 100%; text-align: left; } .btn-theme-toggle i { margin-right: 0.5rem; width: 15px; } #logout-button { width: 100%; text-align: left; margin-top: 0.5rem; } #logout-button i { margin-right: 0.5rem; width: 15px;}


        /* Estilos Restaurante v3 */
        .restaurant-header { flex-shrink: 0; }
        .restaurant-container { display: flex; flex-grow: 1; /* Ocupa espacio restante */ gap: 1rem; overflow: hidden; /* Contiene el scroll */ }

        .tables-section { flex: 1 1 60%; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius); }
        .tables-section .card-header { flex-shrink: 0; background-color: var(--bs-light); /* Fondo claro para header */ }
        #tables-grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); /* Ajustar tamaño mínimo mesa */ gap: 0.8rem; padding: 0.8rem; overflow-y: auto; flex-grow: 1; }
        .table-card { border: 2px solid var(--table-free-border); background-color: var(--table-free-bg); border-radius: var(--bs-border-radius); padding: 0.5rem; text-align: center; cursor: pointer; transition: transform 0.1s ease, border-color 0.2s ease; aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .table-card.status-occupied { border-color: var(--table-occupied-border); background-color: var(--table-occupied-bg); }
        .table-card.status-paying { border-color: var(--table-paying-border); background-color: var(--table-paying-bg); font-weight: bold; }
        .table-card.selected { border-width: 3px; border-color: var(--table-selected-border); transform: scale(1.03); box-shadow: 0 0 8px rgba(var(--bs-primary-rgb), 0.5); }
        .table-card .table-name { font-weight: bold; font-size: 1.1rem; margin-top: 0.2rem; }
        .table-card .table-status-icon { font-size: 1.8rem; line-height: 1; }
        .table-card .table-order-total { font-size: 0.8rem; color: var(--bs-secondary-color); margin-top: 0.1rem; }

        .order-details-section { flex: 1 1 40%; display: flex; flex-direction: column; overflow: hidden; background-color: var(--bs-tertiary-bg); border-radius: var(--bs-border-radius); }
        .order-details-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--bs-border-color); flex-shrink: 0; }
        #order-content { flex-grow: 1; overflow-y: auto; padding: 1rem; /* Scroll para contenido si es necesario */ }
        #order-items-list { /* Ya no necesita overflow ni max-height aquí, el padre (#order-content) lo maneja */ margin-bottom: 1rem; border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius); background-color: var(--bs-body-bg); font-size: 0.9rem; }
        .order-item { /* ... */ display: flex; align-items: center; padding: 0.4rem; border-bottom: 1px solid var(--bs-border-color-translucent); } .order-item:last-child { border-bottom: none; }
        .order-item-details { flex-grow: 1; margin: 0 0.5rem; } .order-item-actions { display: flex; align-items: center; } .order-item-actions button { width: 25px; height: 25px; padding: 0; line-height: 1; font-size: 0.9rem; } .order-item-quantity { margin: 0 0.4rem; min-width: 25px; text-align: center; font-weight: bold;} .order-item-quantity-input { width: 60px; text-align: center; font-weight: bold; border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius-sm); padding: 0.1rem 0.2rem; background-color: var(--bs-body-bg); color: var(--bs-body-color); font-size: 0.9em; margin: 0 0.4rem;}
        .order-item-price { font-weight: bold; min-width: 70px; text-align: right;}
        .order-details-footer { padding: 1rem; border-top: 1px solid var(--bs-border-color); flex-shrink: 0; background-color: var(--bs-secondary-bg); } /* Footer fijo abajo */

        #product-search-results-restaurant { max-height: 150px; overflow-y: auto; border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius); margin-bottom: 1rem; }
        #delivery-info-display { /* ... */ background-color: var(--bs-secondary-bg); padding: 0.5rem; border-radius: var(--bs-border-radius-sm); font-size: 0.85rem; margin-bottom: 1rem;}
        #no-order-selected { padding-top: 3rem; } /* Más espacio si no hay orden */

        /* Modal Admin Mesas / Domicilios (Sin cambios) */
        #table-list .list-group-item { /* ... */ display: flex; justify-content: space-between; align-items: center;}
        #delivery-list { /* ... */ max-height: 300px; overflow-y: auto; } #delivery-list .list-group-item { cursor: pointer; } #delivery-list .list-group-item:hover { background-color: var(--bs-secondary-bg); } #delivery-list .badge { margin-left: auto; }

        /* Responsividad v3 */
        @media (max-width: 992px) {
            html, body { height: auto; overflow: auto; } /* Restaurar scroll normal */
            body { display: block; }
            .sidebar { /* ... (Sidebar horizontal) ... */ width: 100%; height: auto; position: relative; flex-direction: row; align-items: center; padding: 0.5rem 1rem; } .sidebar .app-logo { margin-bottom: 0; margin-right: auto;} .sidebar .nav { flex-direction: row; } .sidebar .nav-link span { display: none; } .sidebar .nav-link i { margin: 0 5px; } .sidebar .sidebar-footer { margin-top: 0; padding: 0; border-top: none; display: flex; } .sidebar .btn-theme-toggle, .sidebar #logout-button { width: auto; margin-left: 10px;} .sidebar .btn-theme-toggle span, .sidebar #logout-button span { display: none; }
            .main-content { height: auto; padding: 1rem; overflow: visible; }
            .restaurant-container { flex-direction: column; height: auto; overflow: visible; }
            .tables-section, .order-details-section { flex: 1 1 auto; overflow: visible; margin-bottom: 1rem; }
            #tables-grid-container { max-height: 40vh; /* Limitar altura en móvil */ }
            #order-content { overflow: visible; } /* No necesita scroll interno en móvil */
            #order-items-list { max-height: none; } /* Sin max-height en móvil */
        }

    </style>
</head>
<body>
    <!-- Barra Lateral Fija -->
     <aside class="sidebar p-3 d-flex flex-column no-print">
        <!-- ... (Contenido Sidebar - Sin Cambios) ... -->
         <div class="app-logo text-center mb-4"> <a href="dashboard.html" class="text-decoration-none d-flex align-items-center justify-content-center"> <i class="fas fa-store fa-lg me-2"></i> <span id="sidebar-business-name" class="app-brand-text fs-5 fw-bold">Gestiona Fácil</span> </a> </div>
         <nav class="nav flex-column nav-pills flex-grow-1"> <a class="nav-link" href="dashboard.html"><i class="fas fa-tachometer-alt"></i><span>Panel Principal</span></a> <a class="nav-link" href="nueva_venta.html"><i class="fas fa-cash-register"></i><span>Nueva Venta</span></a> <a class="nav-link" href="productos.html"><i class="fas fa-boxes"></i><span>Productos</span></a> <a class="nav-link" href="clientes.html"><i class="fas fa-users"></i><span>Clientes</span></a> <a class="nav-link" href="proveedores.html"><i class="fas fa-truck-loading"></i><span>Proveedores</span></a> <a class="nav-link" href="gastos.html"><i class="fas fa-receipt"></i><span>Gastos</span></a> <a class="nav-link" href="caja.html"><i class="fas fa-calculator"></i><span>Caja</span></a> <a class="nav-link" href="inventario.html"><i class="fas fa-clipboard-list"></i><span>Inventario</span></a> <a class="nav-link" href="reportes.html"><i class="fas fa-chart-line"></i><span>Reportes</span></a> <a class="nav-link" href="configuracion.html"><i class="fas fa-cog"></i><span>Configuración</span></a> <a class="nav-link active" id="restaurant-link" href="restaurante.html"><i class="fas fa-utensils"></i><span>Restaurante</span></a> <a class="nav-link" href="ayuda.html"><i class="fas fa-question-circle"></i><span>Ayuda</span></a> </nav>
         <div class="sidebar-footer mt-auto"> <button id="theme-toggle" class="btn btn-outline-secondary btn-theme-toggle" title="Cambiar Tema"> <i class="fas fa-sun"></i> <span></span> </button> <button id="logout-button" class="btn btn-outline-danger btn-sm" title="Salir"> <i class="fas fa-sign-out-alt"></i> <span>Salir</span> </button> </div>
    </aside>

    <!-- Contenido Principal Restaurante -->
    <main class="main-content">
        <!-- Header con Acciones -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2 no-print restaurant-header">
             <h1 class="mb-0 h3">Vista Restaurante</h1>
             <div>
                 <a href="productos.html" class="btn btn-sm btn-outline-secondary"><i class="fas fa-book-open me-1"></i> Admin Menú</a>
                 <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#manageTablesModal"><i class="fas fa-chair me-1"></i> Admin Mesas</button>
                 <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#manageDeliveriesModal"><i class="fas fa-motorcycle me-1"></i> Domicilios</button>
             </div>
         </div>
        <div id="restaurant-error-alert" class="alert alert-danger d-none no-print"></div>

        <!-- Contenedor Principal -->
        <div class="restaurant-container">
            <!-- Sección Mesas -->
            <div class="tables-section card shadow-sm no-print">
                 <div class="card-header"> <h5 class="mb-0">Mesas</h5> </div>
                 <!-- El scroll se aplica al grid directamente -->
                 <div id="tables-grid-container" class="card-body">
                     <div class="text-center text-muted p-4">Cargando mesas...</div>
                 </div>
            </div>

            <!-- Sección Detalles del Pedido -->
            <div class="order-details-section card shadow-sm">
                <div class="order-details-header"> <!-- Header fijo -->
                     <h5 id="order-details-title" class="mb-0 text-center">Selecciona Mesa o Domicilio</h5>
                </div>

                <!-- Contenido scrollable -->
                <div id="order-content" class="flex-grow-1 overflow-auto p-3" style="display: none;">
                     <div id="delivery-info-display" class="d-none"> <!-- Info Domicilio -->
                         <p class="mb-1"><strong>Cliente:</strong> <span id="delivery-customer-name"></span></p>
                         <p class="mb-1"><strong>Tel:</strong> <span id="delivery-customer-phone"></span></p>
                         <p class="mb-0"><strong>Dir:</strong> <span id="delivery-customer-address"></span></p>
                     </div>
                      <!-- Añadir Item -->
                      <div class="input-group input-group-sm mb-2 no-print"> <span class="input-group-text"><i class="fas fa-search"></i></span> <input type="text" id="product-search-input-restaurant" class="form-control" placeholder="Buscar producto..."> </div>
                      <div id="product-search-results-restaurant" class="list-group list-group-flush mb-3 no-print"></div>
                       <!-- Items del Pedido -->
                       <h6 class="mt-2">Items del Pedido</h6>
                       <div id="order-items-list">
                           <div class="text-center text-muted p-3">No hay items en este pedido.</div>
                       </div>
                 </div>

                  <!-- Placeholder si no hay orden seleccionada -->
                 <div id="no-order-selected" class="text-center text-muted p-4 flex-grow-1 d-flex flex-column justify-content-center align-items-center">
                     <i class="fas fa-info-circle fs-3 mb-2"></i><br>
                     Selecciona una mesa libre para iniciar un pedido, o una mesa ocupada/domicilio para ver detalles.
                 </div>

                 <!-- Footer fijo con totales y botones -->
                 <div class="order-details-footer p-3 mt-auto">
                     <div class="d-flex justify-content-between fw-bold fs-5"> <span>TOTAL:</span> <span id="order-total">--</span> </div> <hr>
                     <!-- Sección Pago -->
                     <div class="mb-2 no-print"> <label for="order-payment-method" class="form-label form-label-sm">Método Pago</label> <select id="order-payment-method" class="form-select form-select-sm"> <option value="Efectivo">Efectivo</option> <option value="Tarjeta">Tarjeta</option> <option value="Transferencia">Transferencia</option> <option value="Pago en Entrega" class="delivery-option d-none">Pago en Entrega</option> <option value="Cuenta Abierta">Cuenta Abierta</option> </select> </div>
                     <div id="order-cash-fields" class="row g-1 mb-2 no-print" style="display:none;"> <div class="col"> <input type="number" id="order-cash-received" class="form-control form-control-sm" placeholder="Recibido"> </div> <div class="col"> <input type="text" id="order-cash-change" class="form-control form-control-sm" placeholder="Cambio" readonly disabled> </div> </div>
                     <!-- Botones de Acción -->
                      <div class="d-grid gap-2 d-md-flex justify-content-md-between flex-wrap no-print mt-2">
                          <div class="btn-group btn-group-sm delivery-option d-none"> <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"> Estado Domicilio </button> <ul class="dropdown-menu" id="delivery-status-options"> <li><a class="dropdown-item" href="#" data-status="preparing">En Preparación</a></li> <li><a class="dropdown-item" href="#" data-status="delivering">En Camino</a></li> <li><a class="dropdown-item" href="#" data-status="delivered">Entregado</a></li> </ul> </div>
                          <div class="btn-group btn-group-sm"> <button id="print-kitchen-button" class="btn btn-outline-secondary"><i class="fas fa-print"></i> Cocina</button> <button id="print-delivery-button" class="btn btn-outline-secondary delivery-option d-none"><i class="fas fa-receipt"></i> Domicilio</button> </div>
                          <div class="btn-group btn-group-sm"> <button id="cancel-order-button" class="btn btn-outline-danger"><i class="fas fa-times"></i> Cancelar</button> <button id="charge-order-button" class="btn btn-success"><i class="fas fa-dollar-sign"></i> Cobrar</button> </div>
                      </div>
                  </div>
             </div>
        </div>
    </main>

    <!-- Modals (Admin Mesas, Admin Domicilios, Nuevo Domicilio, Editar Cantidad, Factura) -->
    <!-- ... (Contenido de los modales igual que antes) ... -->
     <div class="modal fade no-print" id="manageTablesModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title">Administrar Mesas</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div> <div class="modal-body"> <form id="add-table-form" class="row g-2 mb-3 align-items-end"> <div class="col"> <label for="new-table-name" class="form-label form-label-sm">Nombre Mesa</label> <input type="text" id="new-table-name" class="form-control form-control-sm" required> </div> <div class="col-auto"> <button type="submit" class="btn btn-sm btn-primary">Añadir Mesa</button> </div> </form> <ul id="table-list" class="list-group"></ul> <div id="manage-tables-feedback" class="mt-2"></div> </div> </div> </div> </div>
     <div class="modal fade no-print" id="manageDeliveriesModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title">Gestionar Domicilios</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div> <div class="modal-body"> <button class="btn btn-sm btn-success mb-3" data-bs-toggle="modal" data-bs-target="#newDeliveryModal"><i class="fas fa-plus me-1"></i> Nuevo Domicilio</button> <h6>Domicilios Activos (Pendientes)</h6> <div id="delivery-list" class="list-group"> <div class="list-group-item text-muted">No hay domicilios activos.</div> </div> </div> </div> </div> </div>
     <div class="modal fade no-print" id="newDeliveryModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title">Nuevo Pedido a Domicilio</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div> <div class="modal-body"> <form id="new-delivery-form" novalidate> <div class="mb-2"> <label for="delivery-cust-name" class="form-label">Nombre Cliente*</label> <input type="text" id="delivery-cust-name" class="form-control form-control-sm" required> </div> <div class="mb-2"> <label for="delivery-cust-phone" class="form-label">Teléfono*</label> <input type="tel" id="delivery-cust-phone" class="form-control form-control-sm" required> </div> <div class="mb-2"> <label for="delivery-cust-address" class="form-label">Dirección*</label> <textarea id="delivery-cust-address" class="form-control form-control-sm" rows="2" required></textarea> </div> <div class="mb-2"> <label for="delivery-cust-notes" class="form-label">Notas Adicionales</label> <textarea id="delivery-cust-notes" class="form-control form-control-sm" rows="1"></textarea> </div> <div class="mb-3"> <label for="delivery-payment-expected" class="form-label">Pago Esperado</label> <select id="delivery-payment-expected" class="form-select form-select-sm"> <option value="Pago en Entrega">Pago en Entrega</option> <option value="Pagado Online">Pagado Online</option> <option value="Transferencia Previa">Transferencia Previa</option> </select> </div> <div id="new-delivery-feedback" class="mt-2"></div> <div class="text-end"> <button type="submit" class="btn btn-primary">Crear Pedido Domicilio</button> </div> </form> </div> </div> </div> </div>
     <div class="modal fade no-print" id="quantityModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="quantityModalLabel">Ingresar Cantidad</h5> <button type="button" class="btn-close" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <input type="hidden" id="quantityModalProductId"> <div class="mb-3"> <label id="quantityModalProductName" class="form-label fw-bold">Nombre Producto</label> </div> <div class="mb-3"> <label for="quantityModalInput" class="form-label">Cantidad (<span id="quantityModalUnit"></span>)</label> <input type="number" step="any" min="0" class="form-control" id="quantityModalInput" required> <div class="invalid-feedback">Ingresa una cantidad válida.</div> <div id="quantityModalStockInfo" class="form-text text-muted"></div> </div> <div id="quantityModalError" class="alert alert-danger d-none"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button> <button type="button" id="quantityModalSaveButton" class="btn btn-primary">Aceptar</button> </div> </div> </div> </div>
     <div class="modal fade no-print" id="invoice-modal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="invoiceModalLabel">Recibo / Comanda (Editable)</h5> <button type="button" class="btn-close" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <p class="text-muted small">Puedes editar el contenido antes de imprimir.</p> <textarea id="invoice-content-editor" class="form-control" style="min-height: 400px; font-family: monospace; white-space: pre;"></textarea> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button> <button type="button" id="print-button" class="btn btn-primary"><i class="fas fa-print me-1"></i> Imprimir</button> </div> </div> </div> </div>
     <div id="print-area" style="display: none;"><pre id="print-content"></pre></div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- JavaScript Personalizado Embebido (VERSIÓN CORRECTA RESTAURADA) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos del DOM ---
            const themeToggleButton = document.getElementById('theme-toggle'); const htmlElement = document.documentElement; const themeIcon = themeToggleButton.querySelector('i'); const themeText = themeToggleButton.querySelector('span'); const logoutButton = document.getElementById('logout-button'); const sidebarBusinessName = document.getElementById('sidebar-business-name'); const restaurantLink = document.getElementById('restaurant-link');
            const restaurantErrorAlert = document.getElementById('restaurant-error-alert');
            const tablesGridContainer = document.getElementById('tables-grid-container');
            const orderDetailsTitle = document.getElementById('order-details-title');
            const orderContentDiv = document.getElementById('order-content');
             const noOrderSelectedDiv = document.getElementById('no-order-selected');
             const deliveryInfoDisplay = document.getElementById('delivery-info-display');
             const deliveryCustomerName = document.getElementById('delivery-customer-name');
             const deliveryCustomerPhone = document.getElementById('delivery-customer-phone');
             const deliveryCustomerAddress = document.getElementById('delivery-customer-address');
             const productSearchInputRestaurant = document.getElementById('product-search-input-restaurant');
             const productSearchResultsRestaurantDiv = document.getElementById('product-search-results-restaurant');
             const orderItemsListDiv = document.getElementById('order-items-list');
             const orderTotalSpan = document.getElementById('order-total');
             const orderPaymentMethodSelect = document.getElementById('order-payment-method');
             const orderCashFieldsDiv = document.getElementById('order-cash-fields');
             const orderCashReceivedInput = document.getElementById('order-cash-received');
             const orderCashChangeInput = document.getElementById('order-cash-change');
             const deliveryStatusOptions = document.getElementById('delivery-status-options');
             const printKitchenButton = document.getElementById('print-kitchen-button');
             const printDeliveryButton = document.getElementById('print-delivery-button');
             const cancelOrderButton = document.getElementById('cancel-order-button');
             const chargeOrderButton = document.getElementById('charge-order-button');
             const deliveryOptionElements = document.querySelectorAll('.delivery-option');
             // Modals
             const manageTablesModalEl = document.getElementById('manageTablesModal'); const manageTablesModal = new bootstrap.Modal(manageTablesModalEl); const addTableForm = document.getElementById('add-table-form'); const newTableNameInput = document.getElementById('new-table-name'); const tableListUl = document.getElementById('table-list'); const manageTablesFeedback = document.getElementById('manage-tables-feedback');
             const manageDeliveriesModalEl = document.getElementById('manageDeliveriesModal'); const manageDeliveriesModal = new bootstrap.Modal(manageDeliveriesModalEl); const deliveryListDiv = document.getElementById('delivery-list');
             const newDeliveryModalEl = document.getElementById('newDeliveryModal'); const newDeliveryModal = new bootstrap.Modal(newDeliveryModalEl); const newDeliveryForm = document.getElementById('new-delivery-form'); const deliveryCustNameInput = document.getElementById('delivery-cust-name'); const deliveryCustPhoneInput = document.getElementById('delivery-cust-phone'); const deliveryCustAddressInput = document.getElementById('delivery-cust-address'); const deliveryCustNotesInput = document.getElementById('delivery-cust-notes'); const deliveryPaymentExpectedSelect = document.getElementById('delivery-payment-expected'); const newDeliveryFeedback = document.getElementById('new-delivery-feedback');
             // Reused Modals
             const quantityModalEl = document.getElementById('quantityModal'); const quantityModal = new bootstrap.Modal(quantityModalEl); const quantityModalProductId = document.getElementById('quantityModalProductId'); const quantityModalProductName = document.getElementById('quantityModalProductName'); const quantityModalUnit = document.getElementById('quantityModalUnit'); const quantityModalInput = document.getElementById('quantityModalInput'); const quantityModalStockInfo = document.getElementById('quantityModalStockInfo'); const quantityModalSaveButton = document.getElementById('quantityModalSaveButton'); const quantityModalError = document.getElementById('quantityModalError');
             const invoiceModalEl = document.getElementById('invoice-modal'); const invoiceModal = new bootstrap.Modal(invoiceModalEl); const invoiceContentEditor = document.getElementById('invoice-content-editor'); const printButton = document.getElementById('print-button'); const printContentPre = document.getElementById('print-content');

             // --- State Variables ---
             let appConfig = {}; let currencyConfig = {}; let allProducts = []; let restaurantTables = []; let activeOrders = [];
             let selectedOrderId = null;
             const decimalUnits = ['Kg', 'Gr', 'Litro', 'Ml', 'Metro', 'Cm'];

            // --- Lógica Tema, Sidebar, Auxiliares ---
            const applyTheme = (theme) => { htmlElement.setAttribute('data-bs-theme', theme); if (theme === 'dark') { themeIcon.className = 'fas fa-sun'; themeText.textContent = ' Tema Claro'; } else { themeIcon.className = 'fas fa-moon'; themeText.textContent = ' Tema Oscuro'; } try { localStorage.setItem('preferredTheme', theme); } catch (e) {} };
            const loadTheme = () => { let pT = null; try { pT = localStorage.getItem('preferredTheme'); } catch (e) {} if (pT) { applyTheme(pT); } else { const pD = window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(pD ? 'dark' : 'light'); } };
            themeToggleButton.addEventListener('click', () => { const cT = htmlElement.getAttribute('data-bs-theme'); applyTheme(cT === 'dark' ? 'light' : 'dark'); }); loadTheme();
            logoutButton.addEventListener('click', () => { if (confirm('¿Seguro?')) window.location.href = 'login.html'; });
            function loadData(key, defaultValue = []) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : defaultValue; } catch (e) { console.error(`LS Load (${key}):`, e); return defaultValue; } }
            function saveData(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); return true; } catch (e) { console.error(`LS Save (${key}):`, e); showError(`Error al guardar ${key}.`); return false; } }
            function generateId() { return 'o' + Date.now().toString(36) + Math.random().toString(36).substring(2, 7); }
            function formatCurrency(amount, config) { if (amount === null || amount === undefined || isNaN(Number(amount))) { amount = 0; } if (!config || !config.code || config.decimals === undefined) { return Number(amount).toLocaleString('es-ES'); } try { const f = new Intl.NumberFormat(getLocaleForCurrency(config.code) || 'es-ES', { style: 'decimal', minimumFractionDigits: config.decimals, maximumFractionDigits: config.decimals }); const fm = f.format(amount); const s = config.symbol || config.code; if (['USD','EUR','GBP','MXN','ARS','COP','CLP','PEN'].includes(config.code)) return `${s}${fm}`; else return `${fm} ${s}`; } catch (e) { return `${config.symbol || ''}${Number(amount).toFixed(config.decimals || 2)}`; } }
            function showError(message) { restaurantErrorAlert.textContent = message; restaurantErrorAlert.classList.remove('d-none'); setTimeout(() => restaurantErrorAlert.classList.add('d-none'), 5000); }
            function showSuccess(message) { restaurantErrorAlert.textContent = message; restaurantErrorAlert.className = 'alert alert-success no-print'; restaurantErrorAlert.classList.remove('d-none'); setTimeout(() => { restaurantErrorAlert.classList.add('d-none'); restaurantErrorAlert.className = 'alert alert-danger d-none no-print'; }, 5000); }
            function showFeedback(element, message, isSuccess = true) { element.textContent = message; element.className = `mt-2 alert alert-sm alert-${isSuccess ? 'success' : 'danger'}`; setTimeout(() => { element.textContent = ''; element.className = 'mt-2'; }, 4000); }
            function isDecimalUnit(unit) { return decimalUnits.includes(unit); }
            function getLocaleForCurrency(code) { const map = { 'USD': 'en-US', 'EUR': 'de-DE', 'COP': 'es-CO', 'MXN': 'es-MX', 'ARS': 'es-AR', 'PEN': 'es-PE', 'CLP': 'es-CL', 'GBP': 'en-GB' }; return map[code];}

             // --- Autenticación y Carga Inicial ---
             function initializeRestaurant() {
                 appConfig = loadData('gestionaFacilConfig'); if (!appConfig || !appConfig.masterPassword) { window.location.href = 'login.html'; return; }
                 currencyConfig = appConfig.currency || { code: 'USD', symbol: '$', decimals: 2 }; if (appConfig.businessName) sidebarBusinessName.textContent = appConfig.businessName; if (appConfig.businessType !== 'restaurant') restaurantLink.classList.add('d-none');
                 allProducts = loadData('productos', []); restaurantTables = loadData('restaurantTables', []); activeOrders = loadData('activeOrders', []);
                 renderTablesGrid(); renderOrderDetails();
                 console.log('Página Restaurante Inicializada.');
             }

            // --- Renderizado Principal ---
            function renderTablesGrid() { /* ... (Igual que antes) ... */ tablesGridContainer.innerHTML = ''; if (restaurantTables.length === 0) { tablesGridContainer.innerHTML = '<p class="text-muted">No hay mesas configuradas.</p>'; return; } restaurantTables.sort((a, b) => (a.name || '').localeCompare(b.name || '')).forEach(table => { const tableOrder = activeOrders.find(o => o.tableId === table.id && o.status !== 'closed' && o.status !== 'cancelled'); let statusClass = ''; let statusIcon = '<i class="fas fa-utensils text-success"></i>'; let orderTotal = 0; if (tableOrder) { if (tableOrder.status === 'paying') { statusClass = 'status-paying'; statusIcon = '<i class="fas fa-hand-holding-usd text-info"></i>'; } else { statusClass = 'status-occupied'; statusIcon = '<i class="fas fa-users text-warning"></i>'; } orderTotal = tableOrder.total || 0; } if (tableOrder && tableOrder.id === selectedOrderId) statusClass += ' selected'; const div = document.createElement('div'); div.className = `table-card ${statusClass}`; div.dataset.tableId = table.id; div.innerHTML = `<div class="table-status-icon">${statusIcon}</div><div class="table-name">${table.name}</div>${tableOrder ? `<div class="table-order-total">${formatCurrency(orderTotal, currencyConfig)}</div>` : ''}`; div.addEventListener('click', () => handleTableClick(table.id)); tablesGridContainer.appendChild(div); }); }
            function renderOrderDetails(orderId = null) { /* ... (Igual que antes) ... */ selectedOrderId = orderId; const order = activeOrders.find(o => o.id === orderId); orderContentDiv.style.display = 'none'; noOrderSelectedDiv.style.display = 'block'; orderDetailsTitle.textContent = 'Selecciona Mesa o Domicilio'; deliveryInfoDisplay.classList.add('d-none'); orderItemsListDiv.innerHTML = '<div class="text-center text-muted p-3">No hay items.</div>'; orderTotalSpan.textContent = formatCurrency(0, currencyConfig); productSearchInputRestaurant.value = ''; productSearchResultsRestaurantDiv.innerHTML = ''; orderPaymentMethodSelect.value = 'Efectivo'; orderCashFieldsDiv.style.display = 'none'; deliveryOptionElements.forEach(el => el.classList.add('d-none')); if (!order) { renderTablesGrid(); return; } orderContentDiv.style.display = 'block'; noOrderSelectedDiv.style.display = 'none'; orderDetailsTitle.textContent = `Pedido: ${order.id}`; if (order.type === 'delivery') { deliveryCustomerName.textContent = order.deliveryInfo?.name || 'N/A'; deliveryCustomerPhone.textContent = order.deliveryInfo?.phone || 'N/A'; deliveryCustomerAddress.textContent = order.deliveryInfo?.address || 'N/A'; deliveryInfoDisplay.classList.remove('d-none'); deliveryOptionElements.forEach(el => el.classList.remove('d-none')); orderDetailsTitle.textContent += ' (Domicilio)'; } else if (order.type === 'table') { const table = restaurantTables.find(t => t.id === order.tableId); orderDetailsTitle.textContent += ` (Mesa ${table ? table.name : '?'})`; } renderOrderItems(order.items || []); updateOrderTotal(order); handleOrderPaymentMethodChange(); renderTablesGrid(); }
            function renderOrderItems(items) { /* ... (Igual que antes) ... */ orderItemsListDiv.innerHTML = ''; if (!items || items.length === 0) { orderItemsListDiv.innerHTML = '<div class="text-center text-muted p-3">Añade productos.</div>'; return; } items.forEach(item => { const div = document.createElement('div'); div.className = 'order-item'; const product = allProducts.find(p => p.id === item.productId); const isDecimal = isDecimalUnit(product?.unit); const quantityDisplay = isDecimal ? `<input type="number" value="${item.quantity}" step="any" min="0.001" class="order-item-quantity-input" data-id="${item.productId}">` : `<span class="order-item-quantity">${item.quantity}</span>`; div.innerHTML = `<div class="order-item-details"><div><strong>${item.name}</strong></div><small class="text-muted">${formatCurrency(item.price, currencyConfig)} / ${product?.unit || 'Und'}</small></div><div class="order-item-actions"><button class="btn btn-sm btn-outline-secondary decrease-order-qty-btn" data-id="${item.productId}" ${isDecimal ? 'disabled' : ''}>-</button>${quantityDisplay}<button class="btn btn-sm btn-outline-secondary increase-order-qty-btn" data-id="${item.productId}" ${isDecimal ? 'disabled' : ''}>+</button></div><span class="order-item-price">${formatCurrency(item.total, currencyConfig)}</span><button class="btn btn-sm btn-outline-danger remove-order-item-btn ms-2" data-id="${item.productId}" title="Quitar"><i class="fas fa-times"></i></button>`; orderItemsListDiv.appendChild(div); if (isDecimal) { const input = div.querySelector('.order-item-quantity-input'); input.addEventListener('change', (e) => handleOrderQuantityInputChange(e.target.dataset.id, e.target.value)); input.addEventListener('click', (e) => e.target.select()); } }); orderItemsListDiv.querySelectorAll('.decrease-order-qty-btn:not([disabled])').forEach(btn => btn.onclick = () => updateOrderItemQuantity(btn.dataset.id, -1)); orderItemsListDiv.querySelectorAll('.increase-order-qty-btn:not([disabled])').forEach(btn => btn.onclick = () => updateOrderItemQuantity(btn.dataset.id, 1)); orderItemsListDiv.querySelectorAll('.remove-order-item-btn').forEach(btn => btn.onclick = () => removeOrderItem(btn.dataset.id)); }
            function updateOrderTotal(order) { /* ... */ if (!order) { orderTotalSpan.textContent = formatCurrency(0, currencyConfig); return; } order.total = (order.items || []).reduce((sum, item) => sum + item.total, 0); orderTotalSpan.textContent = formatCurrency(order.total, currencyConfig); }

             // --- Lógica de Interacción ---
             function handleTableClick(tableId) { /* ... */ const existingOrder = activeOrders.find(o => o.tableId === tableId && o.status !== 'closed' && o.status !== 'cancelled'); if (existingOrder) { renderOrderDetails(existingOrder.id); } else { const newOrder = { id: generateId(), type: 'table', tableId: tableId, status: 'open', items: [], total: 0, createdAt: new Date().toISOString(), deliveryInfo: null }; activeOrders.push(newOrder); if (saveData('activeOrders', activeOrders)) { renderOrderDetails(newOrder.id); } else { activeOrders.pop(); } } }
             productSearchInputRestaurant.addEventListener('input', () => { /* ... */ if (!selectedOrderId) return; const searchTerm = productSearchInputRestaurant.value.toLowerCase().trim(); productSearchResultsRestaurantDiv.innerHTML = ''; if (searchTerm.length < 2) return; const results = allProducts.filter(p => (p.name && p.name.toLowerCase().includes(searchTerm)) || (p.sku && p.sku.toLowerCase().includes(searchTerm))); results.slice(0, 10).forEach(product => { const div = document.createElement('div'); div.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center py-1 px-2'; div.style.fontSize = '0.9em'; div.innerHTML = `<span>${product.name}</span> <span class="badge bg-secondary">${formatCurrency(product.salePrice, currencyConfig)}</span>`; div.onclick = () => addProductToOrder(product.id); productSearchResultsRestaurantDiv.appendChild(div); }); });
             function addProductToOrder(productId) { /* ... */ const orderIndex = activeOrders.findIndex(o => o.id === selectedOrderId); if (orderIndex === -1) { showError("No hay pedido seleccionado."); return; } const product = allProducts.find(p => p.id === productId); if (!product) { showError("Producto no encontrado."); return; } const order = activeOrders[orderIndex]; const existingItemIndex = (order.items || []).findIndex(item => item.productId === productId); const isDecimal = isDecimalUnit(product.unit); if (isDecimal) { openQuantityModalRestaurant(productId); } else { if (existingItemIndex > -1) updateOrderItemQuantity(productId, 1); else { if (!order.items) order.items = []; if (product.manageStock && (product.stock ?? 0) < 1) { showError(`Stock insuficiente para ${product.name}.`); return; } order.items.push({ productId: product.id, name: product.name, quantity: 1, price: product.salePrice, total: product.salePrice }); if (saveData('activeOrders', activeOrders)) { renderOrderItems(order.items); updateOrderTotal(order); } else { order.items.pop(); } } } productSearchInputRestaurant.value = ''; productSearchResultsRestaurantDiv.innerHTML = ''; }
             function openQuantityModalRestaurant(productId) { /* ... */ const product = allProducts.find(p => p.id === productId); if (!product) return; quantityModalProductId.value = productId; quantityModalProductName.textContent = product.name; quantityModalUnit.textContent = product.unit || 'Und'; quantityModalInput.value = ''; quantityModalInput.step = isDecimalUnit(product.unit) ? 'any' : '1'; quantityModalInput.min = isDecimalUnit(product.unit) ? '0.001' : '1'; quantityModalError.classList.add('d-none'); quantityModalInput.classList.remove('is-invalid'); if (product.manageStock) quantityModalStockInfo.textContent = `Stock: ${product.stock ?? 'N/A'} ${product.unit || ''}`; else quantityModalStockInfo.textContent = "No gestionado."; quantityModal.show(); quantityModalEl.addEventListener('shown.bs.modal', () => { quantityModalInput.focus(); quantityModalInput.select(); }, { once: true }); quantityModalSaveButton.onclick = handleSaveRestaurantQuantity; }
             function handleSaveRestaurantQuantity() { /* ... */ const productId = quantityModalProductId.value; const orderIndex = activeOrders.findIndex(o => o.id === selectedOrderId); if (orderIndex === -1) { quantityModal.hide(); return; } const product = allProducts.find(p => p.id === productId); if (!product) return; const quantityStr = quantityModalInput.value; const quantity = parseFloat(quantityStr); const isDecimal = isDecimalUnit(product.unit); quantityModalInput.classList.remove('is-invalid'); quantityModalError.classList.add('d-none'); if (isNaN(quantity) || quantity <= 0 || (!isDecimal && !Number.isInteger(quantity))) { quantityModalInput.classList.add('is-invalid'); quantityModalError.textContent = "Cantidad inválida."; quantityModalError.classList.remove('d-none'); return; } if (product.manageStock && quantity > (product.stock ?? 0)) { quantityModalInput.classList.add('is-invalid'); quantityModalError.textContent = `Stock insuficiente. Disponible: ${product.stock ?? 0}`; quantityModalError.classList.remove('d-none'); return; } const order = activeOrders[orderIndex]; const existingItemIndex = (order.items || []).findIndex(item => item.productId === productId); if (existingItemIndex > -1) { order.items[existingItemIndex].quantity = quantity; order.items[existingItemIndex].total = quantity * order.items[existingItemIndex].price; } else { if (!order.items) order.items = []; order.items.push({ productId: product.id, name: product.name, quantity: quantity, price: product.salePrice, total: quantity * product.salePrice }); } if (saveData('activeOrders', activeOrders)) { renderOrderItems(order.items); updateOrderTotal(order); quantityModal.hide(); } }
             function updateOrderItemQuantity(productId, change) { /* ... */ const orderIndex = activeOrders.findIndex(o => o.id === selectedOrderId); if (orderIndex === -1) return; const order = activeOrders[orderIndex]; const itemIndex = (order.items || []).findIndex(item => item.productId === productId); if (itemIndex === -1) return; const item = order.items[itemIndex]; const newQuantity = item.quantity + change; if (newQuantity <= 0) order.items.splice(itemIndex, 1); else { const product = allProducts.find(p => p.id === productId); if (change > 0 && product?.manageStock && newQuantity > (product.stock ?? 0)) { showError(`Stock insuficiente para ${item.name}.`); return; } item.quantity = newQuantity; item.total = newQuantity * item.price; } if (saveData('activeOrders', activeOrders)) { renderOrderItems(order.items); updateOrderTotal(order); } }
             function handleOrderQuantityInputChange(productId, newValueStr) { /* ... */ const orderIndex = activeOrders.findIndex(o => o.id === selectedOrderId); if (orderIndex === -1) return; const order = activeOrders[orderIndex]; const itemIndex = (order.items || []).findIndex(item => item.productId === productId); if (itemIndex === -1) return; const newValue = parseFloat(newValueStr); const product = allProducts.find(p => p.id === productId); if (isNaN(newValue) || newValue <= 0) { order.items.splice(itemIndex, 1); renderOrderItems(order.items); updateOrderTotal(order); saveData('activeOrders', activeOrders); showError("Cantidad inválida, item eliminado."); return; } if (product?.manageStock && newValue > (product.stock ?? 0)) { showError(`Stock insuficiente. Disponible: ${product.stock ?? 0}.`); renderOrderItems(order.items); return; } order.items[itemIndex].quantity = newValue; order.items[itemIndex].total = newValue * order.items[itemIndex].price; if (saveData('activeOrders', activeOrders)) { renderOrderItems(order.items); updateOrderTotal(order); } }
             function removeOrderItem(productId) { /* ... */ const orderIndex = activeOrders.findIndex(o => o.id === selectedOrderId); if (orderIndex === -1) return; const order = activeOrders[orderIndex]; order.items = (order.items || []).filter(item => item.productId !== productId); if (saveData('activeOrders', activeOrders)) { renderOrderItems(order.items); updateOrderTotal(order); } }

            // --- Lógica Acciones Pedido ---
             cancelOrderButton.addEventListener('click', () => { /* ... */ if (!selectedOrderId) return; const orderIndex = activeOrders.findIndex(o => o.id === selectedOrderId); if (orderIndex === -1) return; const order = activeOrders[orderIndex]; const message = order.type === 'table' ? `¿Cancelar pedido y liberar mesa ${restaurantTables.find(t=>t.id === order.tableId)?.name || '?' }?` : `¿Cancelar domicilio ${order.id}?`; if (confirm(message)) { order.status = 'cancelled'; if (saveData('activeOrders', activeOrders)) { renderOrderDetails(null); renderTablesGrid(); } } });
             chargeOrderButton.addEventListener('click', () => { /* ... */ if (!selectedOrderId) return; const orderIndex = activeOrders.findIndex(o => o.id === selectedOrderId); if (orderIndex === -1) return; const order = activeOrders[orderIndex]; if (!order.items || order.items.length === 0) { showError("No hay items para cobrar."); return; } const paymentMethod = orderPaymentMethodSelect.value; if (!paymentMethod || paymentMethod === 'Cuenta Abierta') { showError("Selecciona método de pago válido."); return; } const total = order.total; let cashReceived = null, cashChange = null; if (paymentMethod === 'Efectivo') { cashReceived = parseFloat(orderCashReceivedInput.value); if (isNaN(cashReceived) || cashReceived < total) { showError("Efectivo recibido insuficiente."); return; } cashChange = cashReceived - total; } const ventaData = { id: generateId(), date: new Date().toISOString(), orderId: order.id, orderType: order.type, tableId: order.tableId, deliveryInfo: order.deliveryInfo, items: order.items, subtotal: order.items.reduce((sum, i) => sum + i.total, 0), total: order.total, paymentMethod: paymentMethod, cashReceived: cashReceived, cashChange: cashChange, clientId: null }; let stockUpdateSuccess = true; const updatedProducts = [...allProducts]; order.items.forEach(item => { const product = updatedProducts.find(p => p.id === item.productId); if (product?.manageStock) product.stock = (product.stock ?? 0) - item.quantity; }); if (!saveData('productos', updatedProducts)) { stockUpdateSuccess = false; showError("¡Error CRÍTICO al actualizar stock!"); return; } else { allProducts = updatedProducts; } let sales = loadData('ventas', []); sales.push(ventaData); if (!saveData('ventas', sales)) { showError("¡Error CRÍTICO al guardar venta!"); return; } order.status = 'closed'; if (saveData('activeOrders', activeOrders)) { showSuccess(`Pedido ${order.id} cobrado y cerrado.`); renderOrderDetails(null); } else { showError("Error al actualizar estado del pedido."); } });
             printKitchenButton.addEventListener('click', () => generateAndShowPrintable('kitchen')); printDeliveryButton.addEventListener('click', () => generateAndShowPrintable('delivery'));
             function generateAndShowPrintable(type) { /* ... */ if (!selectedOrderId) return; const order = activeOrders.find(o => o.id === selectedOrderId); if (!order || !order.items || order.items.length === 0) { showError("No hay items para imprimir."); return; } let content = `COMANDA ${type === 'kitchen' ? 'COCINA' : 'DOMICILIO'}\nPedido ID: ${order.id}\nFecha: ${new Date().toLocaleString('es-ES')}\n`; if (order.type === 'table') content += `Mesa: ${restaurantTables.find(t=>t.id===order.tableId)?.name || '??'}\n`; if (type === 'delivery' && order.deliveryInfo) { content += `--- Cliente Domicilio ---\nNombre: ${order.deliveryInfo.name}\nTel: ${order.deliveryInfo.phone}\nDir: ${order.deliveryInfo.address}\n`; if (order.deliveryInfo.notes) content += `Notas: ${order.deliveryInfo.notes}\n`; content += `Pago Esperado: ${order.deliveryInfo.paymentMethodExpected}\n`; } content += `-------------------------\n`; order.items.forEach(item => { content += `${item.quantity} x ${item.name}\n`; }); content += `-------------------------\n`; if (type === 'delivery') content += `TOTAL: ${formatCurrency(order.total, currencyConfig)}\n`; invoiceModalEl.querySelector('.modal-title').textContent = `Comanda ${type === 'kitchen' ? 'Cocina' : 'Domicilio'} #${order.id}`; invoiceContentEditor.value = content; invoiceModal.show(); }
             printButton.addEventListener('click', () => { const contentToPrint = invoiceContentEditor.value; printContentPre.textContent = contentToPrint; setTimeout(() => window.print(), 250); });

            // --- Lógica Modales Admin ---
             function renderTableList() { /* ... */ tableListUl.innerHTML = ''; if(restaurantTables.length === 0) { tableListUl.innerHTML = '<li class="list-group-item text-muted">No hay mesas.</li>'; return; } restaurantTables.forEach(table => { const isOccupied = activeOrders.some(o => o.tableId === table.id && o.status !== 'closed' && o.status !== 'cancelled'); const li = document.createElement('li'); li.className = 'list-group-item'; li.innerHTML = `<span>${table.name}</span> <button class="btn btn-sm btn-outline-danger delete-table-btn" data-id="${table.id}" ${isOccupied ? 'disabled title="Mesa en uso"' : 'title="Eliminar"'}><i class="fas fa-trash"></i></button>`; tableListUl.appendChild(li); }); }
             addTableForm.addEventListener('submit', (e) => { /* ... */ e.preventDefault(); const name = newTableNameInput.value.trim(); if(!name) return; const newTable = { id: 't' + Date.now(), name: name }; restaurantTables.push(newTable); if(saveData('restaurantTables', restaurantTables)) { showFeedback(manageTablesFeedback, `Mesa "${name}" añadida.`); newTableNameInput.value = ''; renderTableList(); renderTablesGrid();} else { restaurantTables.pop(); showFeedback(manageTablesFeedback, 'Error al añadir.', false); } });
             tableListUl.addEventListener('click', (e) => { /* ... */ const btn = e.target.closest('.delete-table-btn'); if(!btn || btn.disabled) return; const id = btn.dataset.id; const table = restaurantTables.find(t => t.id === id); if(!table) return; if(confirm(`¿Eliminar mesa "${table.name}"?`)) { restaurantTables = restaurantTables.filter(t => t.id !== id); if(saveData('restaurantTables', restaurantTables)) { showFeedback(manageTablesFeedback, 'Mesa eliminada.'); renderTableList(); renderTablesGrid(); } else { restaurantTables = loadData('restaurantTables', []); showFeedback(manageTablesFeedback, 'Error al eliminar.', false); renderTableList(); } } });
             manageTablesModalEl.addEventListener('show.bs.modal', renderTableList);
             function renderDeliveryList() { /* ... */ deliveryListDiv.innerHTML = ''; const activeDeliveries = activeOrders.filter(o => o.type === 'delivery' && o.status !== 'closed' && o.status !== 'cancelled'); if(activeDeliveries.length === 0) { deliveryListDiv.innerHTML = '<div class="list-group-item text-muted">No hay domicilios activos.</div>'; return; } activeDeliveries.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(order => { const statusMap = { open: 'Nuevo', preparing: 'Preparando', delivering: 'En Camino', delivered: 'Entregado' }; const statusBadge = { open: 'primary', preparing: 'info', delivering: 'warning', delivered: 'success' }; const li = document.createElement('a'); li.href = '#'; li.className = 'list-group-item list-group-item-action'; li.dataset.orderId = order.id; li.innerHTML = `<div><strong>Pedido #${order.id}</strong> - ${order.deliveryInfo?.name || '?'} <span class="badge bg-${statusBadge[order.status] || 'secondary'}">${statusMap[order.status] || order.status}</span></div> <small>${new Date(order.createdAt).toLocaleTimeString()}</small>`; li.onclick = (e) => { e.preventDefault(); renderOrderDetails(order.id); manageDeliveriesModal.hide(); }; deliveryListDiv.appendChild(li); }); }
             newDeliveryForm.addEventListener('submit', (e) => { /* ... */ e.preventDefault(); newDeliveryFeedback.textContent = ''; const name = deliveryCustNameInput.value.trim(); const phone = deliveryCustPhoneInput.value.trim(); const address = deliveryCustAddressInput.value.trim(); if(!name || !phone || !address) { showFeedback(newDeliveryFeedback, 'Nombre, teléfono y dirección obligatorios.', false); return; } const newOrder = { id: generateId(), type: 'delivery', status: 'open', items: [], total: 0, createdAt: new Date().toISOString(), tableId: null, deliveryInfo: { name: name, phone: phone, address: address, notes: deliveryCustNotesInput.value.trim() || null, paymentMethodExpected: deliveryPaymentExpectedSelect.value } }; activeOrders.push(newOrder); if(saveData('activeOrders', activeOrders)) { showFeedback(newDeliveryFeedback, `Domicilio #${newOrder.id} creado.`, true); newDeliveryForm.reset(); newDeliveryModal.hide(); renderOrderDetails(newOrder.id); renderDeliveryList(); } else { activeOrders.pop(); showFeedback(newDeliveryFeedback, 'Error al crear.', false); } });
             manageDeliveriesModalEl.addEventListener('show.bs.modal', renderDeliveryList);
             deliveryStatusOptions.addEventListener('click', (e) => { /* ... */ e.preventDefault(); if (e.target.tagName === 'A' && selectedOrderId) { const newStatus = e.target.dataset.status; const orderIndex = activeOrders.findIndex(o => o.id === selectedOrderId); if (orderIndex > -1 && activeOrders[orderIndex].type === 'delivery') { activeOrders[orderIndex].status = newStatus; if(saveData('activeOrders', activeOrders)) { /* showSuccess(`Estado actualizado a: ${newStatus}`); */ } } } });
             orderPaymentMethodSelect.addEventListener('change', handleOrderPaymentMethodChange); function handleOrderPaymentMethodChange(){ orderCashFieldsDiv.style.display = orderPaymentMethodSelect.value === 'Efectivo' ? 'flex' : 'none'; if(orderPaymentMethodSelect.value !== 'Efectivo') { orderCashReceivedInput.value = ''; orderCashChangeInput.value = ''; } }
             orderCashReceivedInput.addEventListener('input', () => { const order = activeOrders.find(o => o.id === selectedOrderId); if(!order) return; const received = parseFloat(orderCashReceivedInput.value); if(!isNaN(received) && received >= order.total) { orderCashChangeInput.value = formatCurrency(received - order.total, currencyConfig); } else { orderCashChangeInput.value = ''; } });

            // --- Inicializar ---
            initializeRestaurant();
        });

    </script>

</body>
</html>
