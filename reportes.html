<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestiona Fácil - Reportes</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Estilos Personalizados Embebidos -->
    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-bg-light: #f8f9fa; --sidebar-text-light: #212529;
            --sidebar-link-hover-bg-light: #e9ecef; --sidebar-link-active-bg-light: #0d6efd; --sidebar-link-active-color-light: #ffffff;
            --sidebar-bg-dark: #212529; --sidebar-text-dark: #adb5bd;
            --sidebar-link-hover-bg-dark: #343a40; --sidebar-link-active-bg-dark: #0d6efd; --sidebar-link-active-color-dark: #ffffff;
        }
        body { display: flex; min-height: 100vh; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); flex-shrink: 0; background-color: var(--sidebar-bg-light); color: var(--sidebar-text-light); transition: background-color 0.3s ease, color 0.3s ease; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; border-right: 1px solid var(--bs-border-color); }
        .sidebar .nav-link { color: var(--sidebar-text-light); }
        .sidebar .nav-link:hover { background-color: var(--sidebar-link-hover-bg-light); }
        .sidebar .nav-link.active { background-color: var(--sidebar-link-active-bg-light); color: var(--sidebar-link-active-color-light); font-weight: 500; }
        .sidebar .nav-link i { margin-right: 0.75rem; width: 20px; text-align: center; }
        .main-content { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }
        [data-bs-theme="dark"] .sidebar { background-color: var(--sidebar-bg-dark); color: var(--sidebar-text-dark); border-right: 1px solid var(--bs-border-color); }
        [data-bs-theme="dark"] .sidebar .nav-link { color: var(--sidebar-text-dark); }
        [data-bs-theme="dark"] .sidebar .nav-link:hover { background-color: var(--sidebar-link-hover-bg-dark); color: #fff; }
        [data-bs-theme="dark"] .sidebar .nav-link.active { background-color: var(--sidebar-link-active-bg-dark); color: var(--sidebar-link-active-color-dark); }
        [data-bs-theme="dark"] .sidebar .btn-theme-toggle { border-color: var(--sidebar-text-dark); color: var(--sidebar-text-dark); }
        [data-bs-theme="dark"] .sidebar .btn-theme-toggle:hover { background-color: var(--sidebar-link-hover-bg-dark); color: #fff; }
        .sidebar-footer { margin-top: auto; padding: 1rem; border-top: 1px solid var(--bs-border-color); }
        .btn-theme-toggle { width: 100%; text-align: left; }
        .btn-theme-toggle i { margin-right: 0.5rem; width: 15px; }
        #logout-button { width: 100%; text-align: left; margin-top: 0.5rem; }
        #logout-button i { margin-right: 0.5rem; width: 15px;}

        /* Estilos Reportes */
        .report-section { display: none; } /* Ocultar secciones hasta generar */
        .report-card .card-header { display: flex; justify-content: space-between; align-items: center; }
        .report-card table { font-size: 0.9rem; }
        .report-card th, .report-card td { padding: 0.5rem; }
        .summary-value { font-size: 1.2rem; font-weight: bold; }

        @media (max-width: 768px) {
            :root { --sidebar-width: 70px; }
            .sidebar .nav-link span, .sidebar .app-brand-text, .sidebar .btn-theme-toggle span, .sidebar #logout-button span { display: none; }
            .sidebar .nav-link i, .sidebar #logout-button i { margin-right: 0; }
            .sidebar .app-logo { padding: 0.5rem; font-size: 1.5rem; }
            .sidebar .sidebar-footer { padding: 0.5rem; }
            .btn-theme-toggle, #logout-button { text-align: center; }
            .btn-theme-toggle i, #logout-button i { margin-right: 0; }
             .filter-form .col-md-4 { width: 50%; }
             .filter-form .col-md-auto { width: 100%; margin-top: 0.5rem;}
        }
         @media (max-width: 576px) {
              .main-content { padding: 1rem; }
         }
    </style>
</head>
<body>
     <!-- Barra Lateral Fija -->
    <aside class="sidebar p-3 d-flex flex-column vh-100 sticky-top">
        <div class="app-logo text-center mb-4">
             <a href="dashboard.html" class="text-decoration-none d-flex align-items-center justify-content-center">
                 <i class="fas fa-store fa-lg me-2"></i>
                 <span id="sidebar-business-name" class="app-brand-text fs-5 fw-bold">Gestiona Fácil</span>
             </a>
        </div>
        <nav class="nav flex-column nav-pills flex-grow-1">
             <a class="nav-link" href="dashboard.html"><i class="fas fa-tachometer-alt"></i><span>Panel Principal</span></a>
             <a class="nav-link" href="nueva_venta.html"><i class="fas fa-cash-register"></i><span>Nueva Venta</span></a>
             <a class="nav-link" href="productos.html"><i class="fas fa-boxes"></i><span>Productos</span></a>
             <a class="nav-link" href="clientes.html"><i class="fas fa-users"></i><span>Clientes</span></a>
             <a class="nav-link" href="proveedores.html"><i class="fas fa-truck-loading"></i><span>Proveedores</span></a>
             <a class="nav-link" href="gastos.html"><i class="fas fa-receipt"></i><span>Gastos</span></a>
             <a class="nav-link" href="caja.html"><i class="fas fa-calculator"></i><span>Caja</span></a>
             <a class="nav-link" href="inventario.html"><i class="fas fa-clipboard-list"></i><span>Inventario</span></a>
             <a class="nav-link active" href="reportes.html"><i class="fas fa-chart-line"></i><span>Reportes</span></a>
             <a class="nav-link" href="configuracion.html"><i class="fas fa-cog"></i><span>Configuración</span></a>
             <a class="nav-link d-none" id="restaurant-link" href="restaurante.html"><i class="fas fa-utensils"></i><span>Restaurante</span></a>
             <a class="nav-link" href="ayuda.html"><i class="fas fa-question-circle"></i><span>Ayuda</span></a>
        </nav>
        <div class="sidebar-footer mt-auto">
            <button id="theme-toggle" class="btn btn-outline-secondary btn-theme-toggle" title="Cambiar Tema">
                 <i class="fas fa-sun"></i> <span></span>
            </button>
            <button id="logout-button" class="btn btn-outline-danger btn-sm" title="Salir">
                 <i class="fas fa-sign-out-alt"></i> <span>Salir</span>
            </button>
        </div>
    </aside>

    <!-- Contenido Principal -->
    <main class="main-content">
        <div class="container-fluid">
             <h1 class="mb-4">Reportes</h1>

             <!-- Filtros de Fecha -->
             <div class="card mb-4 shadow-sm">
                 <div class="card-body">
                     <form id="filter-form" class="row g-3 align-items-end filter-form">
                         <div class="col-md-4">
                             <label for="filter-date-start" class="form-label">Fecha Inicio</label>
                             <input type="date" id="filter-date-start" class="form-control" required>
                              <div class="invalid-feedback">Fecha de inicio requerida.</div>
                         </div>
                          <div class="col-md-4">
                             <label for="filter-date-end" class="form-label">Fecha Fin</label>
                             <input type="date" id="filter-date-end" class="form-control" required>
                              <div class="invalid-feedback">Fecha de fin requerida.</div>
                         </div>
                         <div class="col-md-auto">
                             <button type="submit" id="generate-report-button" class="btn btn-primary w-100">
                                 <i class="fas fa-sync-alt me-1"></i> Generar Reporte
                             </button>
                         </div>
                          <div id="filter-error-message" class="col-12 text-danger mt-2 d-none"></div>
                     </form>
                 </div>
             </div>

              <!-- Contenedor de Reportes (inicialmente oculto) -->
             <div id="reports-container" class="mt-4">

                 <!-- Sección Reporte de Ventas -->
                 <div class="card report-card mb-4 shadow-sm report-section" id="sales-report-section">
                     <div class="card-header">
                         <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Reporte de Ventas</h5>
                         <button class="btn btn-outline-secondary btn-sm export-csv-btn" data-report="sales">
                             <i class="fas fa-download me-1"></i> Exportar CSV
                         </button>
                     </div>
                     <div class="card-body">
                         <div class="row text-center mb-3 gy-3">
                             <div class="col-md-4 border-end">
                                 <div>Total Ventas</div>
                                 <div id="sales-total" class="summary-value text-success">--</div>
                             </div>
                             <div class="col-md-4 border-end">
                                  <div>Número de Transacciones</div>
                                 <div id="sales-count" class="summary-value">--</div>
                             </div>
                             <div class="col-md-4">
                                 <div>Venta Promedio</div>
                                 <div id="sales-average" class="summary-value">--</div>
                             </div>
                         </div>
                         <!-- Podría añadirse tabla detallada de ventas aquí si se desea -->
                     </div>
                 </div>

                 <!-- Sección Productos Más Vendidos -->
                  <div class="card report-card mb-4 shadow-sm report-section" id="top-products-report-section">
                     <div class="card-header">
                         <h5 class="mb-0"><i class="fas fa-star me-2"></i> Productos Más Vendidos</h5>
                          <button class="btn btn-outline-secondary btn-sm export-csv-btn" data-report="top-products">
                             <i class="fas fa-download me-1"></i> Exportar CSV
                         </button>
                     </div>
                     <div class="card-body p-0">
                         <div class="table-responsive">
                             <table class="table table-striped table-hover mb-0">
                                 <thead class="table-light">
                                     <tr><th>#</th><th>Producto</th><th>Cantidad Vendida</th><th>Ingresos Generados</th></tr>
                                 </thead>
                                 <tbody id="top-products-table-body">
                                      <tr><td colspan="4" class="text-center p-3 text-muted">No hay datos de ventas para este período.</td></tr>
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>

                 <!-- Sección Reporte de Inventario -->
                 <div class="card report-card mb-4 shadow-sm report-section" id="inventory-report-section">
                     <div class="card-header">
                         <h5 class="mb-0"><i class="fas fa-boxes me-2"></i> Reporte de Inventario (Estado Actual)</h5>
                          <button class="btn btn-outline-secondary btn-sm export-csv-btn" data-report="inventory">
                             <i class="fas fa-download me-1"></i> Exportar CSV
                         </button>
                     </div>
                     <div class="card-body">
                         <div class="row text-center mb-3 gy-3">
                             <div class="col-md-4 border-end">
                                 <div>Valor Total (Costo)</div>
                                 <div id="inventory-total-cost" class="summary-value">--</div>
                             </div>
                             <div class="col-md-4 border-end">
                                  <div>Valor Total (Venta)</div>
                                 <div id="inventory-total-sale" class="summary-value">--</div>
                             </div>
                             <div class="col-md-4">
                                 <div>Productos Bajo Mínimo</div>
                                 <div id="inventory-low-stock-count" class="summary-value text-warning">--</div>
                             </div>
                         </div>
                         <div class="table-responsive">
                              <table class="table table-striped table-hover table-sm mb-0">
                                 <thead class="table-light">
                                     <tr><th>Producto</th><th>Stock Actual</th><th>Stock Mínimo</th><th>Valor Costo</th><th>Valor Venta</th></tr>
                                 </thead>
                                 <tbody id="inventory-table-body">
                                     <tr><td colspan="5" class="text-center p-3 text-muted">No hay productos con inventario gestionado.</td></tr>
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>

                 <!-- Sección Reporte de Gastos -->
                 <div class="card report-card mb-4 shadow-sm report-section" id="expenses-report-section">
                     <div class="card-header">
                         <h5 class="mb-0"><i class="fas fa-receipt me-2"></i> Reporte de Gastos</h5>
                          <button class="btn btn-outline-secondary btn-sm export-csv-btn" data-report="expenses">
                             <i class="fas fa-download me-1"></i> Exportar CSV
                         </button>
                     </div>
                     <div class="card-body p-0">
                          <div class="table-responsive">
                             <table class="table table-striped table-hover mb-0">
                                 <thead class="table-light">
                                     <tr><th>Categoría</th><th>Monto Total</th><th>% del Total</th></tr>
                                 </thead>
                                 <tbody id="expenses-table-body">
                                      <tr><td colspan="3" class="text-center p-3 text-muted">No hay gastos registrados para este período.</td></tr>
                                 </tbody>
                                 <tfoot class="table-group-divider fw-bold">
                                     <tr>
                                         <td class="text-end">Total Gastos:</td>
                                         <td id="expenses-grand-total" class="text-danger">--</td>
                                         <td>100%</td>
                                     </tr>
                                 </tfoot>
                             </table>
                         </div>
                     </div>
                 </div>

             </div> <!-- /#reports-container -->

        </div> <!-- /.container-fluid -->
    </main>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- JavaScript Personalizado Embebido -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
             // --- Elementos del DOM ---
             const themeToggleButton = document.getElementById('theme-toggle'); /* ... */ const htmlElement = document.documentElement; const themeIcon = themeToggleButton.querySelector('i'); const themeText = themeToggleButton.querySelector('span'); const logoutButton = document.getElementById('logout-button'); const sidebarBusinessName = document.getElementById('sidebar-business-name'); const restaurantLink = document.getElementById('restaurant-link');
             const filterForm = document.getElementById('filter-form');
             const dateStartInput = document.getElementById('filter-date-start');
             const dateEndInput = document.getElementById('filter-date-end');
             const generateButton = document.getElementById('generate-report-button');
              const filterErrorMessage = document.getElementById('filter-error-message');
             const reportsContainer = document.getElementById('reports-container');
             // Sales Report Elements
             const salesReportSection = document.getElementById('sales-report-section');
             const salesTotalEl = document.getElementById('sales-total');
             const salesCountEl = document.getElementById('sales-count');
             const salesAverageEl = document.getElementById('sales-average');
             // Top Products Elements
             const topProductsReportSection = document.getElementById('top-products-report-section');
             const topProductsTableBody = document.getElementById('top-products-table-body');
             // Inventory Report Elements
             const inventoryReportSection = document.getElementById('inventory-report-section');
             const inventoryTotalCostEl = document.getElementById('inventory-total-cost');
             const inventoryTotalSaleEl = document.getElementById('inventory-total-sale');
             const inventoryLowStockCountEl = document.getElementById('inventory-low-stock-count');
             const inventoryTableBody = document.getElementById('inventory-table-body');
             // Expenses Report Elements
             const expensesReportSection = document.getElementById('expenses-report-section');
             const expensesTableBody = document.getElementById('expenses-table-body');
             const expensesGrandTotalEl = document.getElementById('expenses-grand-total');
             const exportCsvButtons = document.querySelectorAll('.export-csv-btn');


             let currencyConfig = {};
             let allProducts = [];
             let allSales = [];
             let allExpenses = [];
             let reportDataCache = { // Cache para datos generados para CSV
                 sales: [],
                 topProducts: [],
                 inventory: [],
                 expenses: []
             };

             // --- Lógica Tema, Sidebar, Auxiliares (Igual que antes) ---
            const applyTheme = (theme) => { /* ... */ htmlElement.setAttribute('data-bs-theme', theme); if (theme === 'dark') { themeIcon.className = 'fas fa-sun'; themeText.textContent = ' Tema Claro'; } else { themeIcon.className = 'fas fa-moon'; themeText.textContent = ' Tema Oscuro'; } try { localStorage.setItem('preferredTheme', theme); } catch (e) {} };
            const loadTheme = () => { /* ... */ let pT = null; try { pT = localStorage.getItem('preferredTheme'); } catch (e) {} if (pT) { applyTheme(pT); } else { const pD = window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(pD ? 'dark' : 'light'); } };
            themeToggleButton.addEventListener('click', () => { const cT = htmlElement.getAttribute('data-bs-theme'); applyTheme(cT === 'dark' ? 'light' : 'dark'); }); loadTheme();
            logoutButton.addEventListener('click', () => { if (confirm('¿Seguro?')) window.location.href = 'login.html'; });
            function loadData(key, defaultValue = []) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : defaultValue; } catch (e) { console.error(`LS Load (${key}):`, e); return defaultValue; } }
            function getLocaleForCurrency(code) { const map = { 'USD': 'en-US', /*...*/ 'COP': 'es-CO', 'MXN': 'es-MX', /*...*/ }; return map[code]; }
            function formatCurrency(amount, config) { /* ... (igual que antes) ... */
                if (amount === null || amount === undefined || isNaN(Number(amount))) { amount = 0; }
                if (!config || !config.code || config.decimals === undefined) { return Number(amount).toLocaleString('es-ES'); }
                try { const f = new Intl.NumberFormat(getLocaleForCurrency(config.code) || 'es-ES', { style: 'decimal', minimumFractionDigits: config.decimals, maximumFractionDigits: config.decimals }); const fm = f.format(amount); const s = config.symbol || config.code; if (['USD','EUR','GBP','MXN','ARS','COP','CLP','PEN'].includes(config.code)) return `${s}${fm}`; else return `${fm} ${s}`; }
                catch (e) { return `${config.symbol || ''}${Number(amount).toFixed(config.decimals || 2)}`; }
            }
             function getISODateString(date) { // Helper para obtener YYYY-MM-DD
                 return date.toISOString().split('T')[0];
             }

             // --- Autenticación y Configuración Inicial ---
            const config = loadData('gestionaFacilConfig');
            if (!config || !config.masterPassword) { window.location.href = 'login.html'; return; }
            currencyConfig = config.currency || { code: 'USD', symbol: '$', decimals: 2 };
            if (config.businessName) sidebarBusinessName.textContent = config.businessName;
            if (config.businessType === 'restaurant') restaurantLink.classList.remove('d-none');

            // --- Carga Inicial de Datos ---
            function loadAllData() {
                 allProducts = loadData('productos');
                 allSales = loadData('ventas');
                 allExpenses = loadData('gastos');
                 console.log(`Datos cargados: ${allProducts.length} P, ${allSales.length} V, ${allExpenses.length} G`);
             }

            // --- Lógica Generación de Reportes ---

            function generateReports(startDateStr, endDateStr) {
                console.log(`Generando reportes de ${startDateStr} a ${endDateStr}`);
                const startDate = new Date(startDateStr + "T00:00:00");
                const endDate = new Date(endDateStr + "T23:59:59");

                // --- 1. Reporte de Ventas ---
                const filteredSales = allSales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= startDate && saleDate <= endDate;
                });
                reportDataCache.sales = filteredSales; // Guardar para CSV

                const totalSalesAmount = filteredSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                const salesCount = filteredSales.length;
                const averageSale = salesCount > 0 ? totalSalesAmount / salesCount : 0;

                salesTotalEl.textContent = formatCurrency(totalSalesAmount, currencyConfig);
                salesCountEl.textContent = salesCount;
                salesAverageEl.textContent = formatCurrency(averageSale, currencyConfig);
                salesReportSection.style.display = 'block';

                // --- 2. Productos Más Vendidos ---
                const productSales = {}; // { productId: { name: '...', quantity: 0, revenue: 0 } }
                filteredSales.forEach(sale => {
                    (sale.items || []).forEach(item => {
                        if (!item.productId) return;
                        if (!productSales[item.productId]) {
                            const productInfo = allProducts.find(p => p.id === item.productId);
                            productSales[item.productId] = {
                                id: item.productId,
                                name: productInfo ? productInfo.name : `Producto ID: ${item.productId}`,
                                quantity: 0,
                                revenue: 0
                            };
                        }
                        productSales[item.productId].quantity += (item.quantity || 0);
                        productSales[item.productId].revenue += (item.total || (item.quantity * item.price)); // Usar total si existe, sino calcular
                    });
                });

                const sortedProducts = Object.values(productSales).sort((a, b) => b.quantity - a.quantity); // Ordenar por cantidad
                reportDataCache.topProducts = sortedProducts; // Guardar para CSV

                topProductsTableBody.innerHTML = '';
                 if (sortedProducts.length > 0) {
                     sortedProducts.forEach((product, index) => {
                         const tr = document.createElement('tr');
                         tr.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${product.name}</td>
                            <td class="text-end">${product.quantity}</td>
                            <td class="text-end">${formatCurrency(product.revenue, currencyConfig)}</td>
                         `;
                         topProductsTableBody.appendChild(tr);
                     });
                 } else {
                    topProductsTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-muted">No hay datos de ventas de productos para este período.</td></tr>`;
                 }
                 topProductsReportSection.style.display = 'block';


                // --- 3. Reporte de Inventario (Estado Actual, no por fecha) ---
                const managedInventory = allProducts.filter(p => p.manageStock);
                reportDataCache.inventory = managedInventory; // Guardar para CSV

                let totalCostValue = 0;
                let totalSaleValue = 0;
                let lowStockCount = 0;
                inventoryTableBody.innerHTML = '';

                if (managedInventory.length > 0) {
                    managedInventory.forEach(p => {
                        const stock = p.stock ?? 0;
                        const costPrice = p.costPrice ?? 0;
                        const salePrice = p.salePrice ?? 0;
                        const itemCostValue = stock * costPrice;
                        const itemSaleValue = stock * salePrice;
                        totalCostValue += itemCostValue;
                        totalSaleValue += itemSaleValue;
                        if (typeof p.minimumStock === 'number' && stock < p.minimumStock) {
                            lowStockCount++;
                        }

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${p.name}</td>
                            <td class="text-end">${stock}</td>
                            <td class="text-end">${p.minimumStock ?? '-'}</td>
                            <td class="text-end">${formatCurrency(itemCostValue, currencyConfig)}</td>
                            <td class="text-end">${formatCurrency(itemSaleValue, currencyConfig)}</td>
                        `;
                        inventoryTableBody.appendChild(tr);
                    });
                } else {
                     inventoryTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-muted">No hay productos con inventario gestionado.</td></tr>`;
                }
                inventoryTotalCostEl.textContent = formatCurrency(totalCostValue, currencyConfig);
                inventoryTotalSaleEl.textContent = formatCurrency(totalSaleValue, currencyConfig);
                inventoryLowStockCountEl.textContent = lowStockCount;
                inventoryReportSection.style.display = 'block';

                // --- 4. Reporte de Gastos ---
                 const filteredExpenses = allExpenses.filter(expense => {
                     const expenseDate = new Date(expense.date);
                     return expenseDate >= startDate && expenseDate <= endDate;
                 });

                 const expensesByCategory = {}; // { categoryName: amount }
                 let grandTotalExpenses = 0;
                 filteredExpenses.forEach(expense => {
                     const category = expense.category || 'Sin Categoría';
                     const amount = expense.amount || 0;
                     if (!expensesByCategory[category]) {
                         expensesByCategory[category] = 0;
                     }
                     expensesByCategory[category] += amount;
                     grandTotalExpenses += amount;
                 });

                 const sortedCategories = Object.entries(expensesByCategory)
                     .sort(([, amountA], [, amountB]) => amountB - amountA); // Ordenar por monto desc

                reportDataCache.expenses = sortedCategories; // Guardar para CSV
                reportDataCache.expensesTotal = grandTotalExpenses; // Guardar total para CSV

                 expensesTableBody.innerHTML = '';
                 if (sortedCategories.length > 0) {
                     sortedCategories.forEach(([category, amount]) => {
                         const percentage = grandTotalExpenses > 0 ? ((amount / grandTotalExpenses) * 100).toFixed(1) : 0;
                         const tr = document.createElement('tr');
                         tr.innerHTML = `
                            <td>${category}</td>
                            <td class="text-end">${formatCurrency(amount, currencyConfig)}</td>
                            <td class="text-end">${percentage}%</td>
                         `;
                         expensesTableBody.appendChild(tr);
                     });
                 } else {
                      expensesTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-muted">No hay gastos registrados para este período.</td></tr>`;
                 }
                 expensesGrandTotalEl.textContent = formatCurrency(grandTotalExpenses, currencyConfig);
                 expensesReportSection.style.display = 'block';

                 reportsContainer.style.display = 'block'; // Mostrar contenedor principal
            }


            // --- Manejo de Filtros y Generación ---
            function handleFilterSubmit(event) {
                 event.preventDefault();
                 event.stopPropagation();
                 filterErrorMessage.classList.add('d-none'); // Ocultar error previo
                 filterForm.classList.remove('was-validated'); // Reset validación Boostrap

                 const startDateStr = dateStartInput.value;
                 const endDateStr = dateEndInput.value;

                 if (!startDateStr || !endDateStr) {
                     filterForm.classList.add('was-validated'); // Mostrar errores de required
                     return;
                 }
                 if (new Date(startDateStr) > new Date(endDateStr)) {
                      filterErrorMessage.textContent = "La fecha de inicio no puede ser posterior a la fecha de fin.";
                      filterErrorMessage.classList.remove('d-none');
                      return;
                 }

                 generateReports(startDateStr, endDateStr);
             }


            // --- Exportación CSV ---
            function generateCSV(reportType) {
                let headers = [];
                let rows = [];
                let filename = `reporte_${reportType}_${dateStartInput.value}_a_${dateEndInput.value}.csv`;

                switch (reportType) {
                    case 'sales':
                        headers = ["ID Venta", "Fecha", "Total", "Método Pago", "ID Cliente (Opcional)"];
                         rows = reportDataCache.sales.map(s => [ s.id, new Date(s.date).toISOString(), s.total, `"${s.paymentMethod || ''}"`, s.clientId || '' ].join(','));
                        break;
                    case 'top-products':
                        headers = ["ID Producto", "Nombre Producto", "Cantidad Vendida", "Ingresos Generados"];
                        rows = reportDataCache.topProducts.map(p => [ p.id, `"${p.name}"`, p.quantity, p.revenue ].join(','));
                         filename = `top_productos_${dateStartInput.value}_a_${dateEndInput.value}.csv`;
                        break;
                     case 'inventory':
                         headers = ["ID Producto", "Nombre", "SKU", "Stock Actual", "Stock Mínimo", "Unidad", "Valor Costo Total", "Valor Venta Total"];
                         rows = reportDataCache.inventory.map(p => {
                             const stock = p.stock ?? 0;
                             const costValue = stock * (p.costPrice ?? 0);
                             const saleValue = stock * (p.salePrice ?? 0);
                             return [ p.id, `"${p.name}"`, p.sku || '', stock, p.minimumStock ?? '', p.unit || '', costValue, saleValue ].join(',');
                         });
                         filename = `inventario_estado_actual_${getISODateString(new Date())}.csv`; // Estado actual, no por fecha
                         break;
                     case 'expenses':
                        headers = ["Categoría", "Monto Total", "% del Total"];
                         rows = reportDataCache.expenses.map(([category, amount]) => {
                              const percentage = reportDataCache.expensesTotal > 0 ? ((amount / reportDataCache.expensesTotal) * 100).toFixed(1) : 0;
                              return [ `"${category}"`, amount, `${percentage}%` ].join(',');
                         });
                         // Añadir fila de total al final
                         rows.push([ "Total", reportDataCache.expensesTotal, "100%" ].join(','));
                          filename = `gastos_${dateStartInput.value}_a_${dateEndInput.value}.csv`;
                         break;
                    default:
                        alert("Tipo de reporte desconocido para exportar.");
                        return;
                }

                 if (rows.length === 0) {
                     alert(`No hay datos para exportar en el reporte de ${reportType}.`);
                     return;
                 }

                 const csv = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join("\n");
                 const link = document.createElement("a");
                 link.setAttribute("href", encodeURI(csv));
                 link.setAttribute("download", filename);
                 document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }

            // --- Carga Inicial y Listeners ---
             function initialize() {
                 loadAllData(); // Cargar todos los datos al inicio
                 // Establecer fechas por defecto (ej. mes actual)
                 const today = new Date();
                 const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                 dateStartInput.value = getISODateString(firstDayOfMonth);
                 dateEndInput.value = getISODateString(today);

                 // Listeners
                 filterForm.addEventListener('submit', handleFilterSubmit);
                 exportCsvButtons.forEach(button => {
                     button.addEventListener('click', () => generateCSV(button.dataset.report));
                 });

                 console.log('Página de Reportes Inicializada.');
            }

            // --- Iniciar ---
             initialize();
        });
    </script>

</body>
</html>