<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración - Mi App de Gestión</title>
    <!-- <link rel="stylesheet" href="css/style.css"> -->
    <style>
        /* Estilos básicos */
        body { font-family: sans-serif; display: flex; margin: 0;}
        .sidebar { width: 200px; background-color: #f4f4f4; padding: 15px; height: 100vh; box-sizing: border-box; overflow-y: auto;}
        .sidebar h2 { margin-top: 0; }
        .sidebar ul { list-style: none; padding: 0; }
        .sidebar ul li a { text-decoration: none; color: #333; display: block; padding: 8px 0; }
        .sidebar ul li a.active { font-weight: bold; }
        .content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; }
        .content header { margin-bottom: 20px; }
        .config-section { border: 1px solid #ccc; padding: 20px; margin-bottom: 25px; background-color: #f9f9f9; border-radius: 5px; }
        .config-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold;}
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 3px;}
        .form-actions { margin-top: 15px; }
        .form-actions button { padding: 10px 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; margin-right: 10px;}
        .data-management button { padding: 12px 20px; font-size: 1.1em; cursor: pointer; border-radius: 4px; margin-right: 15px; margin-bottom: 10px;}
        .export-button { background-color: #28a745; color: white; border: none;}
        .import-button { background-color: #ffc107; color: #333; border: none;}
        .import-section label { display: block; margin-bottom: 10px; font-weight: bold;}
        .import-section input[type="file"] { display: block; margin-bottom: 10px;}
        .warning { color: #dc3545; font-weight: bold; border: 1px solid #dc3545; padding: 10px; border-radius: 4px; background-color: #f8d7da; margin-top: 10px;}
        .hidden { display: none; }
        .error { color: red; font-size: 0.9em; }
        #bank-list li { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dotted #eee; }
        #bank-list button { background: #dc3545; color: white; border: none; padding: 2px 5px; font-size: 0.8em; cursor: pointer; border-radius: 3px;}
    </style>
</head>
<body>

    <nav class="sidebar">
        <h2>Gestiona Fácil</h2>
        <p><small id="business-name-sidebar">Nombre Negocio</small></p>
        <ul>
            <li><a href="dashboard.html">Inicio / Dashboard</a></li>
            <li><a href="nueva_venta.html">Nueva Venta (POS)</a></li>
            <li><a href="restaurante.html">Restaurante</a></li>
            <li><a href="caja.html">Caja</a></li>
            <li><a href="productos.html">Productos</a></li>
            <li><a href="inventario.html">Inventario</a></li>
            <li><a href="proveedores.html">Proveedores</a></li>
            <li><a href="clientes.html">Clientes</a></li>
            <li><a href="gastos.html">Gastos / Pagos</a></li>
            <li><a href="reportes.html">Reportes</a></li>
            <li><a href="configuracion.html" class="active">Configuración</a></li>
            <li><a href="login.html" id="logout-button">Salir</a></li>
        </ul>
    </nav>

    <main class="content">
        <header>
            <h1>Configuración General</h1>
            <p>Ajusta la información de tu negocio y gestiona tus datos.</p>
        </header>

        <!-- Sección Información del Negocio -->
        <section class="config-section">
            <h2>Información del Negocio</h2>
            <form id="business-info-form">
                <div class="form-group">
                    <label for="config-business-name">Nombre del Negocio:</label>
                    <input type="text" id="config-business-name" required>
                </div>
                <div class="form-group">
                    <label for="config-business-address">Dirección (Opcional):</label>
                    <textarea id="config-business-address" rows="2"></textarea>
                </div>
                 <div class="form-group">
                    <label for="config-business-phone">Teléfono (Opcional):</label>
                    <input type="tel" id="config-business-phone">
                </div>
                <div class="form-group">
                    <label for="config-business-taxid">RIF / NIT / ID Fiscal (Opcional):</label>
                    <input type="text" id="config-business-taxid">
                </div>
                 <div class="form-actions">
                     <button type="submit">Guardar Información</button>
                 </div>
            </form>
        </section>

        <!-- Sección Ajustes de la Aplicación -->
        <section class="config-section">
            <h2>Ajustes de la Aplicación</h2>
             <form id="app-settings-form">
                <div class="form-group">
                    <label for="config-currency">Moneda Principal:</label>
                    <select id="config-currency" required>
                        <option value="$">Dólar ($)</option>
                        <option value="€">Euro (€)</option>
                        <option value="Bs.">Bolívares (Bs.)</option>
                        <option value="COP">Peso Colombiano (COP)</option>
                        <!-- Agrega otras monedas si es necesario -->
                    </select>
                </div>
                 <div class="form-group">
                    <label for="config-business-type">Tipo de Negocio:</label>
                    <select id="config-business-type" required>
                        <option value="store">Tienda / Almacén</option>
                        <option value="restaurant">Restaurante</option>
                    </select>
                    <small>Esto ajustará las opciones disponibles (ej: gestión de mesas).</small>
                </div>
                 <!-- Opcional: Configuración de Impuestos Simple -->
                 <!--
                 <div class="form-group">
                     <label for="config-tax-rate">Tasa de Impuesto (%) (Opcional):</label>
                     <input type="number" id="config-tax-rate" step="0.01" min="0">
                 </div>
                 -->
                 <div class="form-actions">
                     <button type="submit">Guardar Ajustes</button>
                 </div>
            </form>
        </section>

         <!-- Sección Seguridad -->
        <section class="config-section">
            <h2>Seguridad</h2>
             <form id="password-change-form">
                <div class="form-group">
                    <label for="current-password">Contraseña Actual:</label>
                    <input type="password" id="current-password" required>
                </div>
                 <div class="form-group">
                    <label for="new-password">Nueva Contraseña:</label>
                    <input type="password" id="new-password" required>
                </div>
                <div class="form-group">
                    <label for="confirm-new-password">Confirmar Nueva Contraseña:</label>
                    <input type="password" id="confirm-new-password" required>
                </div>
                <p id="password-change-error" class="error hidden"></p>
                 <p id="password-change-success" class="hidden" style="color: green;">Contraseña actualizada con éxito.</p>
                 <div class="form-actions">
                     <button type="submit">Cambiar Contraseña</button>
                 </div>
             </form>
        </section>

         <!-- Sección Cuentas Bancarias -->
        <section class="config-section">
             <h2>Cuentas Bancarias (para referencia)</h2>
             <p><small>Agrega aquí las cuentas donde recibes transferencias.</small></p>
            <div>
                <ul id="bank-list">
                    <!-- Bancos se listarán aquí -->
                </ul>
                 <p id="no-banks-message" class="hidden">No hay cuentas bancarias registradas.</p>
            </div>
             <form id="add-bank-form" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                 <input type="text" id="bank-name" placeholder="Nombre Banco" required style="flex: 1; min-width: 150px;">
                 <input type="text" id="bank-info" placeholder="Número Cuenta / Info Adicional" required style="flex: 2; min-width: 200px;">
                 <button type="submit" style="padding: 8px 12px;">+ Agregar</button>
             </form>
        </section>

        <!-- Sección Gestión de Datos -->
        <section class="config-section data-management">
            <h2>Gestión de Datos (¡MUY IMPORTANTE!)</h2>
             <p>Como tus datos se guardan localmente, es <strong>fundamental</strong> que hagas copias de seguridad.</p>

             <button id="export-data-button" class="export-button">Exportar TODOS los Datos (Backup)</button>
             <p><small>Guarda el archivo descargado en un lugar seguro (pendrive, nube, etc.). Haz esto regularmente.</small></p>

             <hr style="margin: 25px 0;">

             <div class="import-section">
                 <label for="import-file-input">Importar Datos (Restaurar desde Backup):</label>
                 <input type="file" id="import-file-input" accept=".json">
                 <button id="import-data-button" class="import-button" disabled>Cargar e Importar Datos</button>
                 <p class="warning"><strong>¡ADVERTENCIA!</strong> Importar un archivo <strong>BORRARÁ TODOS LOS DATOS ACTUALES</strong> y los reemplazará con los del archivo. Asegúrate de seleccionar el archivo de backup correcto.</p>
                 <p id="import-status" class="hidden"></p>
            </div>
        </section>

    </main>

    <!-- <script src="js/app.js"></script> -->
    <!-- <script src="js/configuracion.js"></script> -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const businessNameEl = document.getElementById('business-name-sidebar');
            const configBusinessNameInput = document.getElementById('config-business-name');

            // Forms
            const businessInfoForm = document.getElementById('business-info-form');
            const appSettingsForm = document.getElementById('app-settings-form');
            const passwordChangeForm = document.getElementById('password-change-form');
            const addBankForm = document.getElementById('add-bank-form');

            // Bank List UI
            const bankListUl = document.getElementById('bank-list');
            const noBanksMessage = document.getElementById('no-banks-message');

            // Password change UI
            const currentPasswordInput = document.getElementById('current-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmNewPasswordInput = document.getElementById('confirm-new-password');
            const passwordChangeError = document.getElementById('password-change-error');
            const passwordChangeSuccess = document.getElementById('password-change-success');

            // Data Management UI
            const exportButton = document.getElementById('export-data-button');
            const importFileInput = document.getElementById('import-file-input');
            const importButton = document.getElementById('import-data-button');
            const importStatus = document.getElementById('import-status');

            // --- Carga Inicial ---
            loadConfiguration();
            loadBanks();

            // --- Event Listeners ---
            businessInfoForm.addEventListener('submit', saveBusinessInfo);
            appSettingsForm.addEventListener('submit', saveAppSettings);
            passwordChangeForm.addEventListener('submit', changePassword);
            addBankForm.addEventListener('submit', addBank);

            bankListUl.addEventListener('click', (event) => {
                 if (event.target.classList.contains('delete-bank-btn')) {
                     const bankId = event.target.dataset.id;
                     deleteBank(bankId);
                 }
            });

            exportButton.addEventListener('click', exportAllData);

            importFileInput.addEventListener('change', () => {
                 importButton.disabled = !importFileInput.files || importFileInput.files.length === 0;
            });
            importButton.addEventListener('click', importAllData);


             // --- Funciones ---

            function loadConfiguration() {
                try {
                    const name = localStorage.getItem('businessName') || '';
                    businessNameEl.textContent = name;
                    configBusinessNameInput.value = name;
                    document.getElementById('config-business-address').value = localStorage.getItem('businessAddress') || '';
                    document.getElementById('config-business-phone').value = localStorage.getItem('businessPhone') || '';
                    document.getElementById('config-business-taxid').value = localStorage.getItem('businessTaxId') || '';
                    document.getElementById('config-currency').value = localStorage.getItem('currency') || '$';
                    document.getElementById('config-business-type').value = localStorage.getItem('businessType') || 'store';
                    // document.getElementById('config-tax-rate').value = localStorage.getItem('taxRate') || '';
                } catch (error) {
                    console.error("Error cargando configuración:", error);
                }
            }

             function saveBusinessInfo(event) {
                event.preventDefault();
                try {
                    const newName = configBusinessNameInput.value.trim();
                    localStorage.setItem('businessName', newName);
                    localStorage.setItem('businessAddress', document.getElementById('config-business-address').value.trim());
                    localStorage.setItem('businessPhone', document.getElementById('config-business-phone').value.trim());
                    localStorage.setItem('businessTaxId', document.getElementById('config-business-taxid').value.trim());
                    businessNameEl.textContent = newName; // Update sidebar too
                    alert("Información del negocio guardada.");
                } catch (error) {
                     console.error("Error guardando info negocio:", error);
                     alert("Error al guardar la información del negocio.");
                }
            }

            function saveAppSettings(event) {
                event.preventDefault();
                 try {
                    localStorage.setItem('currency', document.getElementById('config-currency').value);
                    localStorage.setItem('businessType', document.getElementById('config-business-type').value);
                    // localStorage.setItem('taxRate', document.getElementById('config-tax-rate').value);
                    alert("Ajustes de la aplicación guardados. Puede que necesites recargar la página para ver todos los cambios.");
                 } catch (error) {
                    console.error("Error guardando ajustes app:", error);
                    alert("Error al guardar los ajustes de la aplicación.");
                }
            }

             function changePassword(event) {
                event.preventDefault();
                passwordChangeError.classList.add('hidden');
                passwordChangeSuccess.classList.add('hidden');

                const currentPass = currentPasswordInput.value;
                const newPass = newPasswordInput.value;
                const confirmPass = confirmNewPasswordInput.value;

                const storedPassword = localStorage.getItem('masterPassword');

                 if (currentPass !== storedPassword) {
                     passwordChangeError.textContent = 'La contraseña actual es incorrecta.';
                     passwordChangeError.classList.remove('hidden');
                     return;
                 }
                 if (!newPass || newPass.length < 4) { // Basic length check
                     passwordChangeError.textContent = 'La nueva contraseña es muy corta (mínimo 4 caracteres).';
                     passwordChangeError.classList.remove('hidden');
                     return;
                 }
                 if (newPass !== confirmPass) {
                    passwordChangeError.textContent = 'La nueva contraseña y la confirmación no coinciden.';
                    passwordChangeError.classList.remove('hidden');
                    return;
                 }

                 // Si todo está bien
                 try {
                    localStorage.setItem('masterPassword', newPass);
                    passwordChangeSuccess.classList.remove('hidden');
                    passwordChangeForm.reset(); // Limpiar campos
                    console.log("Contraseña actualizada.");
                 } catch (error) {
                    console.error("Error guardando nueva contraseña:", error);
                     passwordChangeError.textContent = 'Error al guardar la nueva contraseña.';
                     passwordChangeError.classList.remove('hidden');
                 }
             }

             // --- Bank Management ---
             function loadBanks() {
                 try {
                    const banks = JSON.parse(localStorage.getItem('config_banks') || '[]');
                    renderBankList(banks);
                 } catch(e) {
                     console.error("Error loading banks", e);
                     renderBankList([]);
                 }
             }

             function renderBankList(banks) {
                 bankListUl.innerHTML = '';
                 if (!banks || banks.length === 0) {
                     noBanksMessage.classList.remove('hidden');
                 } else {
                     noBanksMessage.classList.add('hidden');
                     banks.forEach(bank => {
                         const li = document.createElement('li');
                         li.innerHTML = `
                             <span><strong>${bank.name}</strong>: ${bank.info}</span>
                             <button class="delete-bank-btn" data-id="${bank.id}" title="Eliminar Banco">X</button>
                         `;
                         bankListUl.appendChild(li);
                     });
                 }
             }

             function addBank(event) {
                 event.preventDefault();
                 const bankNameInput = document.getElementById('bank-name');
                 const bankInfoInput = document.getElementById('bank-info');
                 const name = bankNameInput.value.trim();
                 const info = bankInfoInput.value.trim();

                 if (!name || !info) {
                     alert("Debes ingresar el nombre del banco y la información de la cuenta.");
                     return;
                 }

                 try {
                     let banks = JSON.parse(localStorage.getItem('config_banks') || '[]');
                     const newBank = {
                         id: `b${Date.now()}`,
                         name: name,
                         info: info
                     };
                     banks.push(newBank);
                     localStorage.setItem('config_banks', JSON.stringify(banks));
                     renderBankList(banks); // Actualizar la lista visual
                     addBankForm.reset(); // Limpiar el formulario
                 } catch(e) {
                     console.error("Error adding bank", e);
                     alert("Error al agregar la cuenta bancaria.");
                 }
             }

             function deleteBank(bankId) {
                  if (confirm("¿Estás seguro de que quieres eliminar esta cuenta bancaria de la lista?")) {
                     try {
                         let banks = JSON.parse(localStorage.getItem('config_banks') || '[]');
                         banks = banks.filter(b => b.id !== bankId);
                         localStorage.setItem('config_banks', JSON.stringify(banks));
                         renderBankList(banks); // Actualizar la lista visual
                     } catch(e) {
                         console.error("Error deleting bank", e);
                         alert("Error al eliminar la cuenta bancaria.");
                     }
                  }
             }

             // --- Data Management ---

             function exportAllData() {
                console.log("Iniciando exportación de datos...");
                try {
                    const dataToExport = {};
                    const keysToBackup = [
                        'businessName', 'businessAddress', 'businessPhone', 'businessTaxId',
                        'currency', 'businessType', 'taxRate', // Incluir todos los settings
                        'masterPassword', // ¡Incluir con precaución! O excluir si se prefiere más seguridad.
                        'config_banks',
                        'productos',
                        'proveedores',
                        'clientes',
                        'ventas',
                        'gastos',
                        'cashRegisterStatus',
                        'cashHistory',
                        'inventoryAdjustments' // Incluir historial de ajustes si se implementó
                        // Añadir cualquier otra clave que uses
                    ];

                    keysToBackup.forEach(key => {
                         const data = localStorage.getItem(key);
                         if (data !== null) { // Solo exportar si existe
                             dataToExport[key] = data; // Guardar el string tal como está en localStorage
                         }
                    });

                     if (Object.keys(dataToExport).length === 0) {
                         alert("No hay datos para exportar.");
                         return;
                     }

                    const jsonDataString = JSON.stringify(dataToExport, null, 2); // Formateado para legibilidad
                    const blob = new Blob([jsonDataString], { type: 'application/json;charset=utf-8;' });

                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    const dateStr = new Date().toISOString().split('T')[0];
                    link.setAttribute("download", `backup_gestiona_facil_${dateStr}.json`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    console.log("Exportación completada.");
                    alert("¡Exportación completada! Guarda el archivo descargado en un lugar seguro.");

                } catch (error) {
                    console.error("Error durante la exportación:", error);
                    alert("¡Error durante la exportación! Revisa la consola para más detalles.");
                }
             }

             function importAllData() {
                const file = importFileInput.files[0];
                if (!file) {
                    alert("Por favor, selecciona un archivo de backup (.json) primero.");
                    return;
                }

                if (!confirm("¡ADVERTENCIA!\n\nEstás a punto de reemplazar TODOS los datos actuales con los del archivo seleccionado.\n\n¿Estás ABSOLUTAMENTE SEGURO de que quieres continuar? Esta acción no se puede deshacer.")) {
                    importFileInput.value = null; // Resetear input
                    importButton.disabled = true;
                    return;
                }

                const reader = new FileReader();

                reader.onload = function(event) {
                    try {
                        const fileContent = event.target.result;
                        const importedContainer = JSON.parse(fileContent);

                         // ¡Validación básica del archivo importado!
                         if (typeof importedContainer !== 'object' || importedContainer === null) {
                             throw new Error("El archivo no contiene un objeto JSON válido.");
                         }
                         // Podrías añadir más validaciones aquí (ej: verificar si existen claves esperadas)


                        console.log("Archivo leído, iniciando importación...");
                        importStatus.textContent = "Importando...";
                        importStatus.classList.remove('hidden');
                        importStatus.style.color = 'orange';

                         // Limpiar TODO el localStorage actual? O solo las claves conocidas?
                         // Es más seguro solo sobreescribir las claves conocidas para no borrar
                         // otras cosas que el navegador pueda tener.
                         // PERO, si el backup no tiene una clave, esta no se borraría.
                         // --> DECISIÓN: Borrar las claves conocidas antes de importar.
                          const keysToBackup = [ // Reutilizar la lista de exportación
                            'businessName', 'businessAddress', 'businessPhone', 'businessTaxId',
                            'currency', 'businessType', 'taxRate', 'masterPassword', 'config_banks',
                            'productos', 'proveedores', 'clientes', 'ventas', 'gastos',
                            'cashRegisterStatus', 'cashHistory', 'inventoryAdjustments'
                         ];
                         keysToBackup.forEach(key => localStorage.removeItem(key));
                         console.log("LocalStorage conocido limpiado.");


                        // Iterar sobre los datos importados y guardarlos
                        let itemCount = 0;
                        for (const key in importedContainer) {
                            // Solo importar claves que esperamos o que estaban en nuestro contenedor
                             if (keysToBackup.includes(key)) {
                                 const value = importedContainer[key];
                                 // El valor ya debería ser el string que estaba en localStorage
                                 if (typeof value === 'string') {
                                      localStorage.setItem(key, value);
                                      itemCount++;
                                 } else {
                                     console.warn(`Valor para la clave '${key}' no es un string, intentando convertir.`);
                                     // Intentar convertir si no es string (aunque no debería pasar con el export refinado)
                                     try {
                                         localStorage.setItem(key, JSON.stringify(value));
                                         itemCount++;
                                     } catch (stringifyError){
                                         console.error(`No se pudo guardar la clave '${key}':`, stringifyError);
                                     }
                                 }
                             } else {
                                 console.warn(`Clave '${key}' del archivo no reconocida, omitiendo.`);
                             }
                        }

                        console.log(`${itemCount} claves importadas.`);
                        importStatus.textContent = `¡Importación completada! ${itemCount} elementos cargados. Recarga la página para ver los cambios.`;
                        importStatus.style.color = 'green';
                        alert("¡Importación completada! Por favor, recarga la página (F5) para usar los datos importados.");
                        // Forzar recarga: window.location.reload(); (Quizás mejor que el usuario lo haga)

                    } catch (error) {
                        console.error("Error durante la importación:", error);
                        importStatus.textContent = `Error en la importación: ${error.message}. Asegúrate de que el archivo es un backup válido.`;
                        importStatus.style.color = 'red';
                        importStatus.classList.remove('hidden');
                        alert("¡Error durante la importación! El archivo podría estar dañado o no ser un backup válido.");
                    } finally {
                         importFileInput.value = null; // Resetear input
                         importButton.disabled = true;
                    }
                };

                 reader.onerror = function() {
                     console.error("Error leyendo el archivo.");
                     alert("Error al leer el archivo seleccionado.");
                     importStatus.textContent = "Error al leer el archivo.";
                     importStatus.style.color = 'red';
                     importStatus.classList.remove('hidden');
                     importFileInput.value = null; // Resetear input
                     importButton.disabled = true;
                 };

                reader.readAsText(file); // Empezar a leer el archivo
            }


            // Lógica botón Salir
            document.getElementById('logout-button')?.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('¿Estás seguro de que quieres salir?')) {
                    window.location.href = 'login.html';
                }
            });
        });
    </script>

</body>
</html>