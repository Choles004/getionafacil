<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestiona Fácil - Clientes</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Estilos Personalizados Embebidos -->
    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-bg-light: #f8f9fa; --sidebar-text-light: #212529;
            --sidebar-link-hover-bg-light: #e9ecef; --sidebar-link-active-bg-light: #0d6efd; --sidebar-link-active-color-light: #ffffff;
            --sidebar-bg-dark: #212529; --sidebar-text-dark: #adb5bd;
            --sidebar-link-hover-bg-dark: #343a40; --sidebar-link-active-bg-dark: #0d6efd; --sidebar-link-active-color-dark: #ffffff;
        }
        body { display: flex; min-height: 100vh; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); flex-shrink: 0; background-color: var(--sidebar-bg-light); color: var(--sidebar-text-light); transition: background-color 0.3s ease, color 0.3s ease; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; border-right: 1px solid var(--bs-border-color); }
        .sidebar .nav-link { color: var(--sidebar-text-light); }
        .sidebar .nav-link:hover { background-color: var(--sidebar-link-hover-bg-light); }
        .sidebar .nav-link.active { background-color: var(--sidebar-link-active-bg-light); color: var(--sidebar-link-active-color-light); font-weight: 500; }
        .sidebar .nav-link i { margin-right: 0.75rem; width: 20px; text-align: center; }
        .main-content { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }
        [data-bs-theme="dark"] .sidebar { background-color: var(--sidebar-bg-dark); color: var(--sidebar-text-dark); border-right: 1px solid var(--bs-border-color); }
        [data-bs-theme="dark"] .sidebar .nav-link { color: var(--sidebar-text-dark); }
        [data-bs-theme="dark"] .sidebar .nav-link:hover { background-color: var(--sidebar-link-hover-bg-dark); color: #fff; }
        [data-bs-theme="dark"] .sidebar .nav-link.active { background-color: var(--sidebar-link-active-bg-dark); color: var(--sidebar-link-active-color-dark); }
        [data-bs-theme="dark"] .sidebar .btn-theme-toggle { border-color: var(--sidebar-text-dark); color: var(--sidebar-text-dark); }
        [data-bs-theme="dark"] .sidebar .btn-theme-toggle:hover { background-color: var(--sidebar-link-hover-bg-dark); color: #fff; }
        .sidebar-footer { margin-top: auto; padding: 1rem; border-top: 1px solid var(--bs-border-color); }
        .btn-theme-toggle { width: 100%; text-align: left; }
        .btn-theme-toggle i { margin-right: 0.5rem; width: 15px; }
        #logout-button { width: 100%; text-align: left; margin-top: 0.5rem; }
        #logout-button i { margin-right: 0.5rem; width: 15px;}

        /* Estilos Clientes */
        #client-form-container { display: none; } /* Oculto por defecto */
        .table th, .table td { vertical-align: middle; }
        .table .action-buttons a, .table .action-buttons button { margin-right: 5px; padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .debt-positive { color: var(--bs-danger); font-weight: bold; }
        .debt-zero { color: var(--bs-success); }

        /* Estilos Modal Deuda */
        #debt-history-table {
            max-height: 200px; /* Limitar altura tabla historial */
            overflow-y: auto;
            font-size: 0.9rem;
        }
        #debt-history-table th, #debt-history-table td {
            padding: 0.4rem;
        }

        @media (max-width: 768px) {
            :root { --sidebar-width: 70px; }
            .sidebar .nav-link span, .sidebar .app-brand-text, .sidebar .btn-theme-toggle span, .sidebar #logout-button span { display: none; }
            .sidebar .nav-link i, .sidebar #logout-button i { margin-right: 0; }
            .sidebar .app-logo { padding: 0.5rem; font-size: 1.5rem; }
            .sidebar .sidebar-footer { padding: 0.5rem; }
            .btn-theme-toggle, #logout-button { text-align: center; }
            .btn-theme-toggle i, #logout-button i { margin-right: 0; }
        }
         @media (max-width: 576px) {
              .main-content { padding: 1rem; }
         }
    </style>
</head>
<body>
    <!-- Barra Lateral Fija -->
    <aside class="sidebar p-3 d-flex flex-column vh-100 sticky-top">
        <div class="app-logo text-center mb-4">
             <a href="dashboard.html" class="text-decoration-none d-flex align-items-center justify-content-center">
                 <i class="fas fa-store fa-lg me-2"></i>
                 <span id="sidebar-business-name" class="app-brand-text fs-5 fw-bold">Gestiona Fácil</span>
             </a>
        </div>
        <nav class="nav flex-column nav-pills flex-grow-1">
             <a class="nav-link" href="dashboard.html"><i class="fas fa-tachometer-alt"></i><span>Panel Principal</span></a>
             <a class="nav-link" href="nueva_venta.html"><i class="fas fa-cash-register"></i><span>Nueva Venta</span></a>
             <a class="nav-link" href="productos.html"><i class="fas fa-boxes"></i><span>Productos</span></a>
             <a class="nav-link active" href="clientes.html"><i class="fas fa-users"></i><span>Clientes</span></a>
             <a class="nav-link" href="proveedores.html"><i class="fas fa-truck-loading"></i><span>Proveedores</span></a>
             <a class="nav-link" href="gastos.html"><i class="fas fa-receipt"></i><span>Gastos</span></a>
             <a class="nav-link" href="caja.html"><i class="fas fa-calculator"></i><span>Caja</span></a>
             <a class="nav-link" href="inventario.html"><i class="fas fa-clipboard-list"></i><span>Inventario</span></a>
             <a class="nav-link" href="reportes.html"><i class="fas fa-chart-line"></i><span>Reportes</span></a>
             <a class="nav-link" href="configuracion.html"><i class="fas fa-cog"></i><span>Configuración</span></a>
             <a class="nav-link d-none" id="restaurant-link" href="restaurante.html"><i class="fas fa-utensils"></i><span>Restaurante</span></a>
             <a class="nav-link" href="ayuda.html"><i class="fas fa-question-circle"></i><span>Ayuda</span></a>
        </nav>
        <div class="sidebar-footer mt-auto">
            <button id="theme-toggle" class="btn btn-outline-secondary btn-theme-toggle" title="Cambiar Tema">
                 <i class="fas fa-sun"></i> <span></span>
            </button>
            <button id="logout-button" class="btn btn-outline-danger btn-sm" title="Salir">
                 <i class="fas fa-sign-out-alt"></i> <span>Salir</span>
            </button>
        </div>
    </aside>

    <!-- Contenido Principal -->
    <main class="main-content">
        <div class="container-fluid">
             <h1 class="mb-4">Gestión de Clientes</h1>

            <!-- Barra de Acciones -->
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <button id="add-client-button" class="btn btn-primary">
                    <i class="fas fa-user-plus me-1"></i> Agregar Cliente
                </button>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="search-input" class="form-control" placeholder="Buscar cliente...">
                </div>
                 <button id="download-csv-button" class="btn btn-outline-secondary">
                    <i class="fas fa-download me-1"></i> Descargar CSV
                </button>
            </div>

             <!-- Formulario Agregar/Editar Cliente (Oculto) -->
            <div class="card mb-3 shadow-sm" id="client-form-container">
                <div class="card-header">
                    <h5 class="mb-0" id="form-title">Agregar Nuevo Cliente</h5>
                </div>
                 <div class="card-body">
                     <form id="client-form" novalidate>
                         <input type="hidden" id="client-id">
                         <div id="form-error-message" class="alert alert-danger d-none" role="alert"></div>
                         <div class="row g-3">
                             <div class="col-md-6">
                                 <div class="mb-3">
                                     <label for="client-name" class="form-label">Nombre Cliente <span class="text-danger">*</span></label>
                                     <input type="text" class="form-control" id="client-name" required>
                                     <div class="invalid-feedback">El nombre es obligatorio.</div>
                                 </div>
                                 <div class="mb-3">
                                     <label for="client-phone" class="form-label">Teléfono (Opcional)</label>
                                     <input type="tel" class="form-control" id="client-phone">
                                 </div>
                                  <div class="mb-3">
                                     <label for="client-email" class="form-label">Email (Opcional)</label>
                                     <input type="email" class="form-control" id="client-email">
                                      <div class="invalid-feedback">Introduce un email válido.</div>
                                 </div>
                             </div>
                             <div class="col-md-6">
                                 <div class="mb-3">
                                     <label for="client-address" class="form-label">Dirección (Opcional)</label>
                                     <textarea class="form-control" id="client-address" rows="2"></textarea>
                                 </div>
                                 <div class="mb-3">
                                     <label for="client-notes" class="form-label">Notas Adicionales (Opcional)</label>
                                     <textarea class="form-control" id="client-notes" rows="2"></textarea>
                                 </div>
                                  <div class="mb-3">
                                     <label for="client-debt-display" class="form-label">Deuda Actual</label>
                                     <input type="text" class="form-control" id="client-debt-display" readonly disabled>
                                 </div>
                             </div>
                         </div>
                         <hr>
                         <div class="d-flex justify-content-end">
                             <button type="button" id="cancel-button" class="btn btn-secondary me-2">Cancelar</button>
                             <button type="submit" id="save-button" class="btn btn-success"><i class="fas fa-save me-1"></i> Guardar</button>
                         </div>
                     </form>
                 </div>
            </div>

            <!-- Tabla de Clientes -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Listado de Clientes</h5>
                </div>
                <div class="card-body p-0">
                     <div class="table-responsive">
                         <table class="table table-striped table-hover mb-0" id="client-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Teléfono</th>
                                    <th>Email</th>
                                    <th>Deuda Actual</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filas aquí -->
                                 <tr>
                                    <td colspan="5" class="text-center p-4">
                                         <div id="loading-message"><div class="spinner-border spinner-border-sm"></div> Cargando...</div>
                                         <div id="empty-message" class="d-none text-muted">No hay clientes registrados.</div>
                                    </td>
                                </tr>
                            </tbody>
                         </table>
                     </div>
                </div>
            </div>

        </div> <!-- /.container-fluid -->
    </main>

    <!-- Modal Gestionar Deuda -->
    <div class="modal fade" id="manageDebtModal" tabindex="-1" aria-labelledby="manageDebtModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageDebtModalLabel">Gestionar Deuda de: <span id="modal-client-name" class="fw-bold"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modal-client-id">
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span>Deuda Actual:</span>
                        <strong id="modal-current-debt" class="fs-5">--</strong>
                    </div>

                    <div class="row g-4">
                        <!-- Columna Registrar Pago -->
                        <div class="col-md-6 border-end">
                            <h6 class="mb-3"><i class="fas fa-hand-holding-usd me-1 text-success"></i> Registrar Pago</h6>
                            <form id="payment-form" novalidate>
                                <div class="mb-3">
                                    <label for="payment-amount" class="form-label">Monto Pagado <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text" id="modal-currency-symbol-pay">$</span>
                                        <input type="number" step="any" class="form-control" id="payment-amount" required min="0.01">
                                        <div class="invalid-feedback">Monto > 0 y <= Deuda Actual.</div>
                                    </div>
                                </div>
                                 <div class="mb-3">
                                     <label for="payment-date" class="form-label">Fecha Pago <span class="text-danger">*</span></label>
                                     <input type="datetime-local" class="form-control" id="payment-date" required>
                                     <div class="invalid-feedback">La fecha es obligatoria.</div>
                                 </div>
                                <div class="mb-3">
                                    <label for="payment-method" class="form-label">Método Pago <span class="text-danger">*</span></label>
                                    <select id="payment-method" class="form-select" required>
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Tarjeta">Tarjeta</option>
                                        <option value="Transferencia">Transferencia</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                     <div class="invalid-feedback">Selecciona un método.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="payment-notes" class="form-label">Notas (Opcional)</label>
                                    <textarea id="payment-notes" class="form-control" rows="1"></textarea>
                                </div>
                                <button type="submit" class="btn btn-success w-100"><i class="fas fa-check me-1"></i> Registrar Pago</button>
                            </form>
                        </div>

                        <!-- Columna Agregar Cargo -->
                        <div class="col-md-6">
                             <h6 class="mb-3"><i class="fas fa-file-invoice-dollar me-1 text-danger"></i> Agregar Cargo Manual</h6>
                             <form id="charge-form" novalidate>
                                 <div class="mb-3">
                                    <label for="charge-amount" class="form-label">Monto Cargo <span class="text-danger">*</span></label>
                                     <div class="input-group">
                                         <span class="input-group-text" id="modal-currency-symbol-charge">$</span>
                                         <input type="number" step="any" class="form-control" id="charge-amount" required min="0.01">
                                         <div class="invalid-feedback">El monto debe ser > 0.</div>
                                     </div>
                                 </div>
                                  <div class="mb-3">
                                     <label for="charge-date" class="form-label">Fecha Cargo <span class="text-danger">*</span></label>
                                     <input type="datetime-local" class="form-control" id="charge-date" required>
                                     <div class="invalid-feedback">La fecha es obligatoria.</div>
                                 </div>
                                  <div class="mb-3">
                                    <label for="charge-description" class="form-label">Descripción <span class="text-danger">*</span></label>
                                    <input type="text" id="charge-description" class="form-control" required>
                                    <div class="invalid-feedback">La descripción es obligatoria.</div>
                                </div>
                                 <button type="submit" class="btn btn-danger w-100"><i class="fas fa-plus me-1"></i> Agregar Cargo</button>
                             </form>
                        </div>
                    </div>

                    <hr class="my-4">
                    <!-- Historial de Deuda (Opcional) -->
                    <h6 class="mb-2">Historial de Movimientos</h6>
                    <div id="debt-history-table-container" class="table-responsive border rounded" style="max-height: 250px; overflow-y: auto;">
                        <table class="table table-sm table-striped mb-0" id="debt-history-table">
                            <thead class="table-light sticky-top">
                                <tr><th>Fecha</th><th>Tipo</th><th>Descripción/Método</th><th>Monto</th><th>Saldo Resultante</th></tr>
                            </thead>
                            <tbody>
                                <!-- Historial aquí -->
                                <tr><td colspan="5" class="text-center p-3 text-muted">No hay historial de deuda.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- JavaScript Personalizado Embebido -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos del DOM ---
            const themeToggleButton = document.getElementById('theme-toggle'); /*...*/ const htmlElement = document.documentElement; const themeIcon = themeToggleButton.querySelector('i'); const themeText = themeToggleButton.querySelector('span'); const logoutButton = document.getElementById('logout-button'); const sidebarBusinessName = document.getElementById('sidebar-business-name'); const restaurantLink = document.getElementById('restaurant-link');
            const addClientButton = document.getElementById('add-client-button');
            const clientFormContainer = document.getElementById('client-form-container');
            const clientForm = document.getElementById('client-form');
            const formTitle = document.getElementById('form-title');
            const clientIdInput = document.getElementById('client-id');
            const clientNameInput = document.getElementById('client-name');
            const clientPhoneInput = document.getElementById('client-phone');
            const clientEmailInput = document.getElementById('client-email');
            const clientAddressInput = document.getElementById('client-address');
            const clientNotesInput = document.getElementById('client-notes');
            const clientDebtDisplayInput = document.getElementById('client-debt-display');
            const cancelButton = document.getElementById('cancel-button');
            const saveButton = document.getElementById('save-button');
            const formErrorMessage = document.getElementById('form-error-message');
            const clientTableBody = document.querySelector('#client-table tbody');
            const searchInput = document.getElementById('search-input');
            const downloadCsvButton = document.getElementById('download-csv-button');
            const loadingMessage = document.getElementById('loading-message');
            const emptyMessage = document.getElementById('empty-message');

            // Modal Deuda
            const manageDebtModalEl = document.getElementById('manageDebtModal');
            const manageDebtModal = new bootstrap.Modal(manageDebtModalEl);
            const modalClientIdInput = document.getElementById('modal-client-id');
            const modalClientNameSpan = document.getElementById('modal-client-name');
            const modalCurrentDebtSpan = document.getElementById('modal-current-debt');
            const paymentForm = document.getElementById('payment-form');
            const paymentAmountInput = document.getElementById('payment-amount');
            const paymentDateInput = document.getElementById('payment-date');
            const paymentMethodSelect = document.getElementById('payment-method');
            const paymentNotesInput = document.getElementById('payment-notes');
            const chargeForm = document.getElementById('charge-form');
            const chargeAmountInput = document.getElementById('charge-amount');
            const chargeDateInput = document.getElementById('charge-date');
            const chargeDescriptionInput = document.getElementById('charge-description');
            const debtHistoryTableBody = document.querySelector('#debt-history-table tbody');
            const modalCurrencySymbolPay = document.getElementById('modal-currency-symbol-pay');
            const modalCurrencySymbolCharge = document.getElementById('modal-currency-symbol-charge');

            let allClients = []; // Caché local
            let currencyConfig = {}; // Configuración de moneda

            // --- Lógica Tema, Sidebar, Auxiliares (Igual que antes) ---
            const applyTheme = (theme) => { /* ... */ htmlElement.setAttribute('data-bs-theme', theme); if (theme === 'dark') { themeIcon.className = 'fas fa-sun'; themeText.textContent = ' Tema Claro'; } else { themeIcon.className = 'fas fa-moon'; themeText.textContent = ' Tema Oscuro'; } try { localStorage.setItem('preferredTheme', theme); } catch (e) { console.warn("LS Error (Theme):", e); } };
            const loadTheme = () => { /* ... */ let pT = null; try { pT = localStorage.getItem('preferredTheme'); } catch (e) {} if (pT) { applyTheme(pT); } else { const pD = window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(pD ? 'dark' : 'light'); } };
            themeToggleButton.addEventListener('click', () => { const cT = htmlElement.getAttribute('data-bs-theme'); applyTheme(cT === 'dark' ? 'light' : 'dark'); }); loadTheme();
            logoutButton.addEventListener('click', () => { if (confirm('¿Seguro?')) window.location.href = 'login.html'; });
            function loadData(key, defaultValue = null) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : defaultValue; } catch (e) { console.error(`LS Load (${key}):`, e); return defaultValue; } }
            function saveData(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); return true; } catch (e) { console.error(`LS Save (${key}):`, e); alert(`Error al guardar ${key}.`); return false; } }
            function generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }
            function isValidEmail(email) { const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; return re.test(String(email).toLowerCase()); }
            function getLocaleForCurrency(code) { const map = { 'USD': 'en-US', /*...*/ 'COP': 'es-CO', 'MXN': 'es-MX', /*...*/ }; return map[code]; }
            function formatCurrency(amount, config) { /* ... (igual que antes) ... */
                if (amount === null || amount === undefined || isNaN(Number(amount))) { amount = 0; }
                if (!config || !config.code || config.decimals === undefined) { return Number(amount).toLocaleString('es-ES'); }
                try {
                    const formatter = new Intl.NumberFormat(getLocaleForCurrency(config.code) || 'es-ES', { style: 'decimal', minimumFractionDigits: config.decimals, maximumFractionDigits: config.decimals });
                    const formatted = formatter.format(amount);
                    const symbol = config.symbol || config.code;
                    if (['USD','EUR','GBP','MXN','ARS','COP','CLP','PEN'].includes(config.code)) return `${symbol}${formatted}`;
                    else return `${formatted} ${symbol}`;
                } catch (e) { return `${config.symbol || ''}${Number(amount).toFixed(config.decimals || 2)}`; }
            }
            function formatDateTime(isoString) {
                if (!isoString) return '--';
                 try {
                     const date = new Date(isoString);
                     // Incluir fecha y hora
                     return date.toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' });
                 } catch (e) { return 'Inválido'; }
            }
             function getCurrentDateTimeLocalString() {
                 const now = new Date();
                 now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Ajustar a zona horaria local para input
                 return now.toISOString().slice(0, 16); // Formato YYYY-MM-DDTHH:mm
             }


             // --- Autenticación y Configuración Inicial ---
            const config = loadData('gestionaFacilConfig');
            if (!config || !config.masterPassword) { window.location.href = 'login.html'; return; }
            currencyConfig = config.currency || { code: 'USD', symbol: '$', decimals: 2 };
            modalCurrencySymbolPay.textContent = currencyConfig.symbol || '$';
            modalCurrencySymbolCharge.textContent = currencyConfig.symbol || '$';
            if (config.businessName) sidebarBusinessName.textContent = config.businessName;
            if (config.businessType === 'restaurant') restaurantLink.classList.remove('d-none');


            // --- Lógica Formulario Cliente ---
            function resetForm() {
                clientForm.reset(); clientIdInput.value = ''; formTitle.textContent = 'Agregar Nuevo Cliente';
                saveButton.textContent = 'Guardar'; saveButton.classList.replace('btn-warning', 'btn-success');
                formErrorMessage.classList.add('d-none');
                clientForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                clientDebtDisplayInput.value = formatCurrency(0, currencyConfig); // Mostrar 0 al agregar
            }

            function toggleForm(show = true, clientIdToEdit = null) {
                if (show) {
                    resetForm();
                    if (clientIdToEdit) {
                        const client = allClients.find(c => c.id === clientIdToEdit);
                        if (client) {
                            formTitle.textContent = 'Editar Cliente'; saveButton.textContent = 'Actualizar';
                            saveButton.classList.replace('btn-success', 'btn-warning');
                            clientIdInput.value = client.id; clientNameInput.value = client.name || '';
                            clientPhoneInput.value = client.phone || ''; clientEmailInput.value = client.email || '';
                            clientAddressInput.value = client.address || ''; clientNotesInput.value = client.notes || '';
                            clientDebtDisplayInput.value = formatCurrency(client.debt || 0, currencyConfig);
                        } else { console.error("Cliente a editar no encontrado:", clientIdToEdit); alert("Error al buscar cliente."); return; }
                    }
                    clientFormContainer.style.display = 'block'; clientNameInput.focus();
                } else { clientFormContainer.style.display = 'none'; }
            }

             function validateClientForm() {
                 let isValid = true;
                 formErrorMessage.classList.add('d-none'); formErrorMessage.innerHTML = '';
                 clientForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                 if (!clientNameInput.value.trim()) { clientNameInput.classList.add('is-invalid'); isValid = false; }
                 const email = clientEmailInput.value.trim();
                 if (email && !isValidEmail(email)) { clientEmailInput.classList.add('is-invalid'); isValid = false; }
                 if (!isValid) { formErrorMessage.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i> Corrige los errores.'; formErrorMessage.classList.remove('d-none'); const firstInvalid = clientForm.querySelector('.is-invalid'); if (firstInvalid) firstInvalid.focus(); }
                 return isValid;
            }

            function handleClientFormSubmit(event) {
                 event.preventDefault(); event.stopPropagation();
                 if (!validateClientForm()) return;
                 const clientId = clientIdInput.value;
                 const isEditing = !!clientId;

                 // IMPORTANTE: Al editar, NO MODIFICAMOS la deuda aquí. Solo info básica.
                 const clientData = {
                     id: isEditing ? clientId : generateId(),
                     name: clientNameInput.value.trim(),
                     phone: clientPhoneInput.value.trim() || null,
                     email: clientEmailInput.value.trim() || null,
                     address: clientAddressInput.value.trim() || null,
                     notes: clientNotesInput.value.trim() || null,
                     // Mantenemos la deuda y el historial existentes si estamos editando
                     debt: isEditing ? (allClients.find(c => c.id === clientId)?.debt || 0) : 0,
                     debtHistory: isEditing ? (allClients.find(c => c.id === clientId)?.debtHistory || []) : []
                 };

                 if (isEditing) {
                     allClients = allClients.map(c => c.id === clientId ? clientData : c);
                 } else {
                     allClients.push(clientData);
                 }

                 if (saveData('clientes', allClients)) {
                     console.log(`Cliente ${isEditing ? 'actualizado' : 'agregado'}:`, clientData.id);
                     filterTable(); toggleForm(false);
                 } else { allClients = loadData('clientes', []); formErrorMessage.innerHTML = 'Error al guardar.'; formErrorMessage.classList.remove('d-none'); }
            }


            // --- Lógica Tabla Clientes ---
             function renderTable(clientsToRender) {
                 clientTableBody.innerHTML = ''; loadingMessage.classList.add('d-none');
                 if (!clientsToRender || clientsToRender.length === 0) { emptyMessage.classList.remove('d-none'); clientTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted p-4">No hay clientes.</td></tr>`; return; }
                 emptyMessage.classList.add('d-none');

                 clientsToRender.sort((a, b) => (a.name || '').localeCompare(b.name || '')); // Ordenar por nombre

                 clientsToRender.forEach(client => {
                     const debt = client.debt || 0;
                     const debtClass = debt > 0 ? 'debt-positive' : 'debt-zero';
                     const tr = document.createElement('tr');
                     tr.innerHTML = `
                        <td>${client.name || 'N/A'}</td>
                        <td>${client.phone || '-'}</td>
                        <td>${client.email || '-'}</td>
                        <td class="${debtClass}">${formatCurrency(debt, currencyConfig)}</td>
                        <td class="text-end action-buttons">
                             <button class="btn btn-sm btn-outline-warning manage-debt-btn" data-id="${client.id}" title="Gestionar Deuda">
                                <i class="fas fa-dollar-sign"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${client.id}" title="Editar Cliente">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${client.id}" title="Eliminar Cliente">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                     `;
                     clientTableBody.appendChild(tr);
                 });
             }

            function filterTable() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                if (!searchTerm) { renderTable(allClients); return; }
                const filtered = allClients.filter(c =>
                    (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                    (c.phone && c.phone.toLowerCase().includes(searchTerm)) ||
                    (c.email && c.email.toLowerCase().includes(searchTerm))
                );
                renderTable(filtered);
            }

            function deleteClient(clientId) {
                 const client = allClients.find(c => c.id === clientId);
                 if (!client) return;

                 // Decisión de negocio: Permitir eliminar con deuda? Por ahora sí, pero advertir.
                 let confirmationMessage = `¿Seguro de eliminar al cliente "${client.name}"?`;
                 if (client.debt && client.debt > 0) {
                     confirmationMessage += `\n\n¡ATENCIÓN! Este cliente tiene una deuda pendiente de ${formatCurrency(client.debt, currencyConfig)}. Si lo eliminas, esta información se perderá.`;
                 }
                  confirmationMessage += "\n\nEsta acción no se puede deshacer.";

                 if (confirm(confirmationMessage)) {
                     allClients = allClients.filter(c => c.id !== clientId);
                     if (saveData('clientes', allClients)) {
                         console.log('Cliente eliminado:', clientId);
                         filterTable();
                     } else { allClients = loadData('clientes', []); alert("Error al guardar eliminación."); }
                 }
             }


            // --- Lógica Modal Gestión Deuda ---

            function openManageDebtModal(clientId) {
                 const client = allClients.find(c => c.id === clientId);
                 if (!client) { alert("Error: Cliente no encontrado."); return; }

                 modalClientIdInput.value = client.id;
                 modalClientNameSpan.textContent = client.name || 'N/A';
                 updateModalDebtDisplay(client.debt || 0);

                 // Resetear formularios del modal
                 paymentForm.reset();
                 chargeForm.reset();
                 paymentForm.classList.remove('was-validated');
                 chargeForm.classList.remove('was-validated');

                 // Poner fecha actual por defecto
                 paymentDateInput.value = getCurrentDateTimeLocalString();
                 chargeDateInput.value = getCurrentDateTimeLocalString();

                 // Limitar máximo del pago
                 paymentAmountInput.max = (client.debt || 0).toFixed(currencyConfig.decimals);

                 renderDebtHistory(client.debtHistory || []);
                 manageDebtModal.show();
            }

             function updateModalDebtDisplay(newDebt) {
                 const debt = newDebt || 0;
                 modalCurrentDebtSpan.textContent = formatCurrency(debt, currencyConfig);
                 modalCurrentDebtSpan.className = `fs-5 fw-bold ${debt > 0 ? 'text-danger' : 'text-success'}`;
                 // Actualizar max del input de pago
                  paymentAmountInput.max = debt.toFixed(currencyConfig.decimals);
             }

             function renderDebtHistory(history) {
                debtHistoryTableBody.innerHTML = '';
                 if (!history || history.length === 0) {
                     debtHistoryTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-3 text-muted">No hay historial.</td></tr>';
                     return;
                 }
                 // Ordenar por fecha descendente
                 history.sort((a, b) => new Date(b.date) - new Date(a.date));

                 history.forEach(item => {
                     const tr = document.createElement('tr');
                     const typeClass = item.type === 'payment' ? 'text-success' : (item.type === 'charge' ? 'text-danger' : '');
                     const typeIcon = item.type === 'payment' ? '<i class="fas fa-arrow-down"></i> Pago' : (item.type === 'charge' ? '<i class="fas fa-arrow-up"></i> Cargo' : (item.type === 'sale' ? '<i class="fas fa-shopping-cart"></i> Venta' : 'Otro'));
                     tr.innerHTML = `
                        <td>${formatDateTime(item.date)}</td>
                        <td class="${typeClass}">${typeIcon}</td>
                        <td>${item.description || item.paymentMethod || '-'}</td>
                        <td class="text-end ${typeClass}">${formatCurrency(item.amount, currencyConfig)}</td>
                        <td class="text-end">${formatCurrency(item.balanceAfter, currencyConfig)}</td>
                     `;
                     debtHistoryTableBody.appendChild(tr);
                 });
             }

             function handlePaymentSubmit(event) {
                event.preventDefault(); event.stopPropagation();
                if (!paymentForm.checkValidity()) {
                    paymentForm.classList.add('was-validated'); return;
                }

                const clientId = modalClientIdInput.value;
                const clientIndex = allClients.findIndex(c => c.id === clientId);
                if (clientIndex === -1) { alert("Error: Cliente no encontrado."); return; }

                const amount = parseFloat(paymentAmountInput.value);
                const currentDebt = allClients[clientIndex].debt || 0;

                 // Re-validar monto contra deuda actual
                if (isNaN(amount) || amount <= 0 || amount > currentDebt) {
                     paymentAmountInput.classList.add('is-invalid');
                     paymentAmountInput.nextElementSibling.textContent = `El monto debe ser > 0 y <= ${formatCurrency(currentDebt, currencyConfig)}.`;
                     return;
                } else {
                     paymentAmountInput.classList.remove('is-invalid');
                     paymentAmountInput.nextElementSibling.textContent = `Monto > 0 y <= Deuda Actual.`; // Reset message
                }


                const newDebt = currentDebt - amount;
                const historyEntry = {
                    id: generateId(),
                    date: paymentDateInput.value ? new Date(paymentDateInput.value).toISOString() : new Date().toISOString(),
                    type: 'payment', // 'pago'
                    amount: amount,
                    paymentMethod: paymentMethodSelect.value,
                    notes: paymentNotesInput.value.trim() || null,
                    balanceAfter: newDebt
                };

                 // Actualizar cliente
                 allClients[clientIndex].debt = newDebt;
                 if (!allClients[clientIndex].debtHistory) { allClients[clientIndex].debtHistory = []; }
                 allClients[clientIndex].debtHistory.push(historyEntry);

                 if (saveData('clientes', allClients)) {
                     console.log('Pago registrado para:', clientId, amount);
                     updateModalDebtDisplay(newDebt);
                     renderDebtHistory(allClients[clientIndex].debtHistory);
                     paymentForm.reset(); // Reset form
                     paymentDateInput.value = getCurrentDateTimeLocalString(); // Set date again
                     paymentForm.classList.remove('was-validated');
                     filterTable(); // Actualizar tabla principal
                 } else {
                     // Revertir si falla guardado
                     allClients = loadData('clientes', []);
                     alert("Error al guardar el pago.");
                 }
            }

            function handleChargeSubmit(event) {
                 event.preventDefault(); event.stopPropagation();
                 if (!chargeForm.checkValidity()) {
                     chargeForm.classList.add('was-validated'); return;
                 }

                 const clientId = modalClientIdInput.value;
                 const clientIndex = allClients.findIndex(c => c.id === clientId);
                 if (clientIndex === -1) { alert("Error: Cliente no encontrado."); return; }

                 const amount = parseFloat(chargeAmountInput.value);
                 if (isNaN(amount) || amount <= 0) {
                      chargeAmountInput.classList.add('is-invalid'); return;
                 } else { chargeAmountInput.classList.remove('is-invalid'); }

                 const currentDebt = allClients[clientIndex].debt || 0;
                 const newDebt = currentDebt + amount;
                 const historyEntry = {
                     id: generateId(),
                     date: chargeDateInput.value ? new Date(chargeDateInput.value).toISOString() : new Date().toISOString(),
                     type: 'charge', // 'cargo manual'
                     amount: amount,
                     description: chargeDescriptionInput.value.trim(),
                     balanceAfter: newDebt
                 };

                  allClients[clientIndex].debt = newDebt;
                  if (!allClients[clientIndex].debtHistory) { allClients[clientIndex].debtHistory = []; }
                  allClients[clientIndex].debtHistory.push(historyEntry);

                  if (saveData('clientes', allClients)) {
                      console.log('Cargo registrado para:', clientId, amount);
                      updateModalDebtDisplay(newDebt);
                      renderDebtHistory(allClients[clientIndex].debtHistory);
                      chargeForm.reset();
                      chargeDateInput.value = getCurrentDateTimeLocalString();
                      chargeForm.classList.remove('was-validated');
                      filterTable();
                 } else {
                      allClients = loadData('clientes', []);
                      alert("Error al guardar el cargo.");
                 }
            }


            // --- Carga Inicial y Listeners ---
            function initialize() {
                 allClients = loadData('clientes', []);
                 renderTable(allClients);

                 // Listeners generales
                 addClientButton.addEventListener('click', () => toggleForm(true));
                 cancelButton.addEventListener('click', () => toggleForm(false));
                 clientForm.addEventListener('submit', handleClientFormSubmit);
                 searchInput.addEventListener('input', filterTable);
                 downloadCsvButton.addEventListener('click', generateCSV);

                 // Listeners delegados para tabla
                 clientTableBody.addEventListener('click', (event) => {
                    const button = event.target.closest('button');
                    if (!button) return;
                    const clientId = button.dataset.id;
                    if (!clientId) return;

                    if (button.classList.contains('edit-btn')) {
                        toggleForm(true, clientId);
                    } else if (button.classList.contains('delete-btn')) {
                        deleteClient(clientId);
                    } else if (button.classList.contains('manage-debt-btn')) {
                         openManageDebtModal(clientId);
                    }
                 });

                 // Listeners para modal
                 paymentForm.addEventListener('submit', handlePaymentSubmit);
                 chargeForm.addEventListener('submit', handleChargeSubmit);

                 // Recalcular deuda si se cierra el modal (podría haber cambios)
                  manageDebtModalEl.addEventListener('hidden.bs.modal', () => {
                     filterTable(); // Re-renderizar tabla principal para asegurar que deuda esté actualizada
                 });

                 console.log('Página de Clientes Inicializada.');
            }

            // --- CSV ---
            function generateCSV() {
                 if (allClients.length === 0) { alert("No hay clientes."); return; }
                 const headers = ["ID", "Nombre", "Teléfono", "Email", "Dirección", "Notas", "Deuda Actual"];
                 const rows = allClients.map(c => [
                     c.id, `"${c.name || ''}"`, c.phone || '', c.email || '',
                     `"${(c.address || '').replace(/"/g, '""')}"`, `"${(c.notes || '').replace(/"/g, '""')}"`,
                     c.debt || 0
                 ].join(','));
                 const csv = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join("\n");
                 const link = document.createElement("a");
                 link.setAttribute("href", encodeURI(csv));
                 link.setAttribute("download", `clientes_gestiona_facil_${new Date().toISOString().slice(0,10)}.csv`);
                 document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }


            // --- Iniciar ---
            initialize();
        });
    </script>

</body>
</html>